{
  "analysis_timestamp": "2025-12-01T20:15:00Z",
  "workflow_id": "sw3Qs3Fe3JahEbbW",
  "workflow_name": "FoodTracker",

  "critical_finding": {
    "issue": "Invalid node type: n8n-nodes-base.supabaseTool",
    "node_id": "3b9dc923-9a6d-4970-afce-71c99582c1e4",
    "node_name": "Create a row in Supabase",
    "severity": "BLOCKING",
    "explanation": "Node type 'supabaseTool' does NOT exist in n8n. This is an AI Agent tool node, not a standalone Supabase node."
  },

  "database_schema": {
    "table_name": "foodtracker_entries",
    "schema": "public",
    "required_columns": [
      {
        "name": "user_id",
        "type": "uuid",
        "nullable": false,
        "description": "User UUID from users table"
      },
      {
        "name": "date",
        "type": "date",
        "nullable": false,
        "description": "Entry date"
      },
      {
        "name": "owner",
        "type": "text",
        "nullable": false,
        "description": "Owner name (Sergey/Alena)"
      },
      {
        "name": "food_item",
        "type": "text",
        "nullable": false,
        "description": "Food name in Russian"
      }
    ],
    "optional_columns": [
      {
        "name": "quantity",
        "type": "numeric",
        "nullable": true,
        "description": "Amount"
      },
      {
        "name": "unit",
        "type": "text",
        "nullable": true,
        "description": "Measurement unit (grams/ml/pcs)"
      },
      {
        "name": "calories",
        "type": "integer",
        "nullable": true,
        "default": 0
      },
      {
        "name": "protein",
        "type": "integer",
        "nullable": true,
        "default": 0
      },
      {
        "name": "fats",
        "type": "integer",
        "nullable": true,
        "default": 0
      },
      {
        "name": "carbs",
        "type": "integer",
        "nullable": true,
        "default": 0
      },
      {
        "name": "fiber",
        "type": "integer",
        "nullable": true,
        "default": 0
      },
      {
        "name": "source",
        "type": "text",
        "nullable": true,
        "default": "'manual'::text"
      },
      {
        "name": "nutrition_source",
        "type": "text",
        "nullable": true,
        "description": "openfoodfacts | gpt-estimate | manual"
      },
      {
        "name": "confidence",
        "type": "text",
        "nullable": true,
        "description": "high | medium | low"
      },
      {
        "name": "openfoodfacts_code",
        "type": "text",
        "nullable": true,
        "description": "Barcode from OpenFoodFacts"
      },
      {
        "name": "nutriscore",
        "type": "text",
        "nullable": true,
        "description": "Nutri-Score grade: a to e"
      }
    ],
    "auto_generated": [
      {
        "name": "id",
        "type": "uuid",
        "default": "gen_random_uuid()"
      },
      {
        "name": "created_at",
        "type": "timestamp with time zone",
        "default": "now()"
      },
      {
        "name": "synced_to_notion",
        "type": "boolean",
        "default": "false"
      }
    ]
  },

  "current_node_config": {
    "node_id": "3b9dc923-9a6d-4970-afce-71c99582c1e4",
    "node_name": "Create a row in Supabase",
    "type": "n8n-nodes-base.supabaseTool",
    "typeVersion": 1,
    "position": [1648, 688],
    "connection_type": "ai_tool",
    "connected_to": "AI Agent",
    "parameters": {
      "tableId": "foodtracker_entries"
    },
    "credentials": {
      "supabaseApi": {
        "id": "DYpIGQK8a652aosj",
        "name": "Supabase account"
      }
    }
  },

  "correct_node_types": {
    "for_ai_agent_tool": {
      "type": "INVALID",
      "explanation": "n8n-nodes-base.supabaseTool does NOT exist. This was likely a mistake.",
      "correct_approach": "Use @n8n/n8n-nodes-langchain.toolHttpRequest (already exists as 'Save Food Entry')"
    },
    "for_standalone_operation": {
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "operations": [
        "create",
        "delete",
        "get",
        "getAll",
        "update"
      ],
      "example_nodes_in_workflow": [
        "Log Message (message_processing_log)",
        "Check User (users table)"
      ]
    }
  },

  "workflow_data_flow": {
    "text_path": "Telegram → Switch → Process Text → AI Agent",
    "voice_path": "Telegram → Switch → Process Voice → Download Voice → Transcribe → Merge Voice Data → AI Agent",
    "photo_barcode_path": "Telegram → Switch → Process Photo → Download Photo → Extract Barcode → Parse Barcode → IF Has Barcode → Get OpenFoodFacts → Parse OpenFoodFacts → IF OpenFoodFacts Success → [true: Merge Photo Paths] [false: Get UPC Database → Parse UPC → IF UPC Success → [true: Merge Photo Paths] [false: Restore Binary for Vision → Vision Analysis → Parse Vision Result → Merge Photo Paths]] → AI Agent",
    "ai_agent_tools": [
      {
        "name": "Save Food Entry",
        "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
        "purpose": "INSERT food entries via RPC function",
        "status": "CORRECT"
      },
      {
        "name": "Create a row in Supabase",
        "type": "n8n-nodes-base.supabaseTool",
        "purpose": "UNKNOWN - duplicate/incorrect tool",
        "status": "INVALID NODE TYPE"
      }
    ]
  },

  "data_mapping": {
    "ai_agent_provides": {
      "telegram_user_id": "from input JSON",
      "food_item": "extracted from user message",
      "quantity": "extracted/estimated",
      "unit": "extracted (grams/ml/pcs)",
      "calories": "calculated/estimated",
      "protein": "calculated/estimated",
      "carbs": "calculated/estimated",
      "fats": "calculated/estimated",
      "fiber": "optional"
    },
    "save_food_entry_rpc": {
      "function_name": "save_food_entry",
      "endpoint": "https://qyemyvplvtzpukvktkae.supabase.co/rest/v1/rpc/save_food_entry",
      "method": "POST",
      "parameters": [
        "p_telegram_user_id (number)",
        "p_food_item (string)",
        "p_quantity (number)",
        "p_unit (string)",
        "p_calories (number)",
        "p_protein (number)",
        "p_carbs (number)",
        "p_fats (number)",
        "p_fiber (number, optional)"
      ],
      "status": "Already configured correctly in 'Save Food Entry' node"
    }
  },

  "other_supabase_nodes": {
    "working_nodes": [
      {
        "id": "98883f54-610b-485a-a45b-83b7bfd88a8f",
        "name": "Log Message",
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "operation": "create",
        "table": "message_processing_log",
        "status": "CORRECT"
      },
      {
        "id": "90b986bb-f244-4a25-9d55-a3f2baa451bf",
        "name": "Check User",
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "operation": "get",
        "table": "users",
        "status": "CORRECT"
      }
    ]
  },

  "fix_recommendations": {
    "option_1_remove_duplicate": {
      "action": "DELETE node 'Create a row in Supabase'",
      "reason": "'Save Food Entry' already handles INSERT operations via RPC",
      "impact": "Zero functional impact - 'Save Food Entry' is the correct tool",
      "steps": [
        "Remove connection from AI Agent to 'Create a row in Supabase'",
        "Delete node 3b9dc923-9a6d-4970-afce-71c99582c1e4",
        "Keep 'Save Food Entry' (cccfae9d-4439-438c-9471-baf194b83445) as-is"
      ],
      "recommended": true
    },
    "option_2_fix_node_type": {
      "action": "REPLACE with correct node type",
      "reason": "If you need READ operations (Get Food Entries)",
      "new_config": {
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "operation": "getAll",
        "tableId": "foodtracker_entries",
        "filters": "AI Agent provides search criteria"
      },
      "impact": "Enables AI Agent to search existing entries",
      "note": "But AI prompt mentions 'Get Food Entries' tool - check if it's implemented"
    },
    "option_3_add_langchain_tool": {
      "action": "Add Supabase Langchain Tool for READ operations",
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "purpose": "Allow AI Agent to query existing entries",
      "example": "Search for 'курица', get today's total, etc.",
      "note": "AI prompt mentions this functionality but tool may be missing"
    }
  },

  "root_cause_analysis": {
    "how_this_happened": "Invalid node type 'supabaseTool' suggests either:",
    "theories": [
      "1. Builder created wrong node type (typo: supabaseTool vs supabase)",
      "2. n8n version mismatch (node type changed between versions)",
      "3. Copy-paste from template that had wrong type",
      "4. AI Agent tried to auto-create tool node (wrong type)"
    ],
    "most_likely": "Builder error - 'supabaseTool' looks like a guess at the AI tool node name",
    "correct_ai_tools": [
      "@n8n/n8n-nodes-langchain.toolHttpRequest (for HTTP APIs)",
      "@n8n/n8n-nodes-langchain.toolCode (for custom logic)",
      "n8n-nodes-base.supabase is NOT an AI tool - it's a standalone node"
    ]
  },

  "qa_validation_errors": {
    "error_e003": {
      "node": "Create a row in Supabase",
      "message": "Invalid node type: n8n-nodes-base.supabaseTool",
      "severity": "CRITICAL",
      "blocks_deployment": true
    }
  },

  "impact_assessment": {
    "current_state": "Workflow validation fails, cannot deploy",
    "functionality_impact": "ZERO - 'Save Food Entry' already does this job correctly",
    "fix_complexity": "SIMPLE - just delete the duplicate node",
    "estimated_fix_time": "30 seconds",
    "breaking_risk": "NONE - node is not connected to main flow"
  },

  "learnings_to_add": {
    "learning_id": "L-069",
    "title": "Supabase AI Tool Misconception",
    "pattern": "n8n-nodes-base.supabaseTool does NOT exist",
    "correct_approach": {
      "for_ai_agent_tools": "Use @n8n/n8n-nodes-langchain.toolHttpRequest to call Supabase RPC",
      "for_standalone_operations": "Use n8n-nodes-base.supabase (regular node)",
      "never_use": "n8n-nodes-base.supabaseTool (invalid type)"
    },
    "example": "FoodTracker workflow - 'Save Food Entry' (toolHttpRequest) is correct, 'Create a row in Supabase' (supabaseTool) is invalid"
  }
}
