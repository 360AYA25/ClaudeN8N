# üìã Migration Plan: Distributed Project Structure + Auto-Context

**Created:** 2025-12-09
**Author:** Claude Code (Sonnet 4.5)
**Goal:** Migrate from centralized to distributed project structure with auto-updating context
**Timeline:** 2-3 hours implementation + testing

---

## üéØ Executive Summary

### What We're Changing

**FROM: Centralized Model**
```
ClaudeN8N/memory/
‚îú‚îÄ‚îÄ run_state_active.json           # Shared by all projects
‚îú‚îÄ‚îÄ workflow_snapshots/             # All projects mixed
‚îî‚îÄ‚îÄ agent_results/                  # All projects mixed

MultiBOT/bots/food-tracker/
‚îî‚îÄ‚îÄ (no workflow state, no context)
```

**TO: Distributed Model**
```
ClaudeN8N/
‚îú‚îÄ‚îÄ .claude/agents/                 # Universal agents (no changes)
‚îî‚îÄ‚îÄ docs/learning/LEARNINGS.md      # Global learnings only

MultiBOT/bots/food-tracker/
‚îú‚îÄ‚îÄ .n8n/                          # ‚≠ê NEW! Project workflow data
‚îÇ   ‚îú‚îÄ‚îÄ canonical.json
‚îÇ   ‚îú‚îÄ‚îÄ run_state.json
‚îÇ   ‚îú‚îÄ‚îÄ history/
‚îÇ   ‚îî‚îÄ‚îÄ agent_results/
‚îî‚îÄ‚îÄ .context/                       # ‚≠ê NEW! Auto-updating context
    ‚îú‚îÄ‚îÄ SYSTEM-CONTEXT.md
    ‚îú‚îÄ‚îÄ sources.json
    ‚îî‚îÄ‚îÄ context-version.json
```

### Why We're Changing

1. **Portability:** Each project is self-contained (can copy/backup as single folder)
2. **Isolation:** No mixing of project data
3. **Git-friendly:** Workflow state tracked with project code
4. **Auto-context:** SYSTEM-CONTEXT.md auto-updates via Analyst agent
5. **Scalability:** Unlimited projects without memory/ bloat

---

## üì¶ Phase 1: New Structure Implementation

### 1.1 Create Project Structure Template

**File:** `.claude/templates/project-structure/`

```bash
# Create template
mkdir -p .claude/templates/project-structure/.n8n/history
mkdir -p .claude/templates/project-structure/.n8n/agent_results
mkdir -p .claude/templates/project-structure/.context
```

**Files to create:**

#### `.claude/templates/project-structure/.n8n/README.md`
```markdown
# .n8n/ - Project Workflow Data

**Auto-managed by ClaudeN8N Orchestrator**

## Files

- `canonical.json` - Current workflow snapshot
- `run_state.json` - Active session state
- `history/` - Session history (by date)
- `agent_results/` - Agent outputs (research, build, qa)

## DO NOT EDIT MANUALLY

These files are auto-generated by agents.
To modify workflow, use: `/orch <task>`
```

#### `.claude/templates/project-structure/.context/sources.json`
```json
{
  "project_type": "n8n-workflow",
  "project_name": "[PROJECT_NAME]",
  "workflow_id": "[WORKFLOW_ID]",
  "sources": {
    "architecture": {
      "file": "ARCHITECTURE.md",
      "sections": ["System Overview", "Workflow Structure", "Critical Rules"]
    },
    "session_state": {
      "file": "SESSION_CONTEXT.md",
      "sections": ["Current State", "Next Actions"]
    },
    "tasks": {
      "file": "TODO.md",
      "filter": ["in_progress", "next_up", "blocked"]
    },
    "learnings": {
      "file": "../../ClaudeN8N/docs/learning/LEARNINGS.md",
      "project_filter": "[project-tag]",
      "limit": 10
    },
    "workflow": {
      "canonical": ".n8n/canonical.json"
    },
    "database": {
      "file": "SUPABASE-SCHEMA.md",
      "sections": ["Tables Overview", "RPC Functions"]
    }
  },
  "update_triggers": [
    "workflow_version_change",
    "new_learnings",
    "todo_progress",
    "session_complete"
  ]
}
```

#### `.claude/templates/project-structure/.context/SYSTEM-CONTEXT-TEMPLATE.md`
```markdown
# üéØ Project Context - [PROJECT_NAME]

**Auto-generated by Analyst Agent**
**Last Updated:** [TIMESTAMP]
**Context Version:** v[N]
**Workflow Version:** v[N]

---

## üè∑Ô∏è Project Type

[n8n-workflow | web-app | cli-tool]

## üìä Current State

- Phase: [phase]
- Progress: [X%]
- Current Task: [task]
- Workflow ID: [id] (v[version])
- Status: [Production | Development]

---

## üîß Services Stack

| Service | Type | ID/URL | Credential ID |
|---------|------|--------|---------------|
| [Service] | [Type] | [URL] | [ID] |

---

## üóÑÔ∏è Database Schema

**Tables ([X] total):**
- [table]: [purpose]

**RPC Functions ([X] total):**
```sql
function_name(params) ‚Üí RETURNS type
```

---

## üèóÔ∏è Architecture Overview

**Workflow Structure:**
- Total Nodes: [X]
- Phase 1: [X nodes] - [purpose]

---

## üö® Critical Rules

**MUST:**
- ‚úÖ [Rule]

**MUST NOT:**
- ‚ùå [Anti-pattern]

---

## üìö Applied Learnings

**Recent (Last 10):**
- **[Date] L-XXX:** [Title]

---

## üìù Active Tasks

**In Progress:**
- [ ] [Task]

---

## ‚ö†Ô∏è Common Gotchas

1. **[Gotcha]:** [Solution]

---

**Source Files:**
- ARCHITECTURE.md (last updated: [date])
- SESSION_CONTEXT.md (last updated: [date])

**Refresh Command:** `/orch refresh context`
```

---

### 1.2 Migration Script

**File:** `scripts/migrate-to-distributed.sh`

```bash
#!/bin/bash
# Migrate project to distributed structure

PROJECT_PATH="$1"
WORKFLOW_ID="$2"

if [ -z "$PROJECT_PATH" ] || [ -z "$WORKFLOW_ID" ]; then
  echo "Usage: ./migrate-to-distributed.sh <project_path> <workflow_id>"
  exit 1
fi

echo "üöÄ Migrating $PROJECT_PATH to distributed structure..."

# 1. Create folders
mkdir -p "$PROJECT_PATH/.n8n/history"
mkdir -p "$PROJECT_PATH/.n8n/agent_results"
mkdir -p "$PROJECT_PATH/.context"

# 2. Copy canonical snapshot
if [ -f "memory/workflow_snapshots/$WORKFLOW_ID/canonical.json" ]; then
  cp "memory/workflow_snapshots/$WORKFLOW_ID/canonical.json" \
     "$PROJECT_PATH/.n8n/canonical.json"
  echo "‚úÖ Copied canonical.json"
fi

# 3. Copy run_state (if exists for this workflow)
if [ -f "memory/run_state_active.json" ]; then
  ACTIVE_WORKFLOW=$(jq -r '.workflow_id' memory/run_state_active.json)
  if [ "$ACTIVE_WORKFLOW" = "$WORKFLOW_ID" ]; then
    cp "memory/run_state_active.json" "$PROJECT_PATH/.n8n/run_state.json"
    echo "‚úÖ Copied run_state.json"
  fi
fi

# 4. Copy history
if [ -d "memory/run_state_history/$WORKFLOW_ID" ]; then
  cp -r "memory/run_state_history/$WORKFLOW_ID/"* \
        "$PROJECT_PATH/.n8n/history/"
  echo "‚úÖ Copied history"
fi

# 5. Copy agent results
if [ -d "memory/agent_results/$WORKFLOW_ID" ]; then
  cp -r "memory/agent_results/$WORKFLOW_ID/"* \
        "$PROJECT_PATH/.n8n/agent_results/"
  echo "‚úÖ Copied agent_results"
fi

# 6. Copy templates
cp .claude/templates/project-structure/.n8n/README.md \
   "$PROJECT_PATH/.n8n/"
cp .claude/templates/project-structure/.context/sources.json \
   "$PROJECT_PATH/.context/"

echo "‚úÖ Migration complete!"
echo "Next: Update .context/sources.json with project details"
```

---

## üìù Phase 2: Analyst Agent Extension

### 2.1 Update analyst.md

**File:** `.claude/agents/analyst.md`

**Add new section:**

```markdown
## ROLE 2: Context Manager

**Trigger:**
- Post-session (stage: complete)
- Manual: `/orch refresh context`

### Protocol

1. **Read sources configuration:**
   ```javascript
   const sources = Read(`${project_path}/.context/sources.json`)
   const projectType = sources.project_type
   ```

2. **Extract data from source files:**
   - Architecture: Read specified sections
   - Session state: Current state, tasks, progress
   - TODO: Filter by status (in_progress, next_up, blocked)
   - Learnings: Last 10 + project-specific filter
   - Workflow: canonical.json version
   - Database: Schema summary

3. **Generate SYSTEM-CONTEXT.md:**
   ```javascript
   const template = Read(".claude/templates/project-structure/.context/SYSTEM-CONTEXT-TEMPLATE.md")

   // Replace placeholders:
   // [PROJECT_NAME], [TIMESTAMP], [VERSION], etc.

   const context = fillTemplate(template, {
     projectName: sources.project_name,
     timestamp: new Date().toISOString(),
     contextVersion: currentVersion + 1,
     workflowVersion: canonical.version,
     // ... extract all data
   })

   Write(`${project_path}/.context/SYSTEM-CONTEXT.md`, context)
   ```

4. **Update metadata:**
   ```javascript
   Write(`${project_path}/.context/context-version.json`, {
     version: newVersion,
     last_updated: timestamp,
     workflow_version: canonical.version,
     changes: [list of changes]
   })
   ```

5. **Log changes:**
   ```javascript
   const log = Read(`${project_path}/.context/changes-log.json`) || { updates: [] }
   log.updates.push({
     version: newVersion,
     date: timestamp,
     workflow_version: canonical.version,
     changes: {...},
     trigger: "post_session" | "manual",
     updated_by: "Analyst"
   })
   Write(`${project_path}/.context/changes-log.json`, log)
   ```

6. **Commit to git (if repo):**
   ```bash
   cd ${project_path}
   git add .context/SYSTEM-CONTEXT.md .context/*.json
   git commit -m "chore: auto-update context v${newVersion}

   - Workflow v${workflow_version}
   - ${changes_count} changes

   ü§ñ Generated by Analyst Agent"
   ```

### Validation

**Before update:**
- ‚úÖ sources.json exists and valid JSON
- ‚úÖ All source files readable
- ‚úÖ Workflow canonical accessible

**After update:**
- ‚úÖ SYSTEM-CONTEXT.md < 3,000 tokens
- ‚úÖ Context version incremented
- ‚úÖ All mandatory sections present
- ‚úÖ Git commit successful (if repo)

### Error Handling

- Source file not found ‚Üí Use placeholder
- Workflow version unavailable ‚Üí Use "unknown"
- Git commit fails ‚Üí Log warning, continue
```

---

## üîÑ Phase 3: Orchestrator Updates

### 3.1 Update orch.md

**File:** `.claude/commands/orch.md`

**Changes:**

#### SESSION START (add context check)

```markdown
## SESSION START (MANDATORY)

1. **Locate project files:**
   ```javascript
   // Get project_path from run_state or user input
   const projectPath = run_state.project_path || userProvidedPath

   // Project files:
   const runState = Read(`${projectPath}/.n8n/run_state.json`)
   const canonical = Read(`${projectPath}/.n8n/canonical.json`)
   const context = Read(`${projectPath}/.context/SYSTEM-CONTEXT.md`)
   const sources = Read(`${projectPath}/.context/sources.json`)
   ```

2. **Check context freshness:**
   ```javascript
   const contextVersion = extractVersion(context) // "Context Version: v12"
   const workflowVersion = canonical.version

   if (contextVersion < workflowVersion) {
     // Context outdated! Refresh first
     Task({
       subagent_type: "general-purpose",
       prompt: `## ROLE: Analyst Agent (Context Manager)

       Read: .claude/agents/analyst.md (ROLE 2: Context Manager)

       ## TASK: Refresh SYSTEM-CONTEXT.md

       Context outdated: v${contextVersion} vs workflow v${workflowVersion}
       Project: ${projectPath}

       Update SYSTEM-CONTEXT.md with latest data.`
     })

     // Re-read fresh context
     context = Read(`${projectPath}/.context/SYSTEM-CONTEXT.md`)
   }
   ```

3. **Pass context to agents:**
   ```javascript
   Task({
     subagent_type: "general-purpose",
     model: "opus", // for Builder only
     prompt: `## ROLE: [Agent] Agent

     Read files in this order:
     1. ${projectPath}/.context/SYSTEM-CONTEXT.md (PROJECT CONTEXT - ALWAYS FIRST!)
     2. .claude/agents/[agent].md
     3. ${projectPath}/.n8n/run_state.json

     ## TASK
     [task description]`
   })
   ```
```

#### SESSION END (add context update)

```markdown
## SESSION END (Post-Session Protocol)

When stage reaches "complete":

1. **Check if context needs update:**
   ```javascript
   const needsUpdate = (
     workflowVersionChanged ||
     newLearningsAdded ||
     todoProgressChanged
   )

   if (needsUpdate) {
     Task({
       subagent_type: "general-purpose",
       prompt: `## ROLE: Analyst Agent (Context Manager)

       Read: .claude/agents/analyst.md (ROLE 2)

       ## TASK: Update SYSTEM-CONTEXT.md

       Session complete. Update context:
       - Project: ${projectPath}
       - Workflow: ${workflowId} (v${workflowVersion})
       - Trigger: post_session

       Sync all sources and increment version.`
     })
   }
   ```

2. **Archive run_state:**
   ```javascript
   const timestamp = new Date().toISOString().split('T')[0]
   const archivePath = `${projectPath}/.n8n/history/${timestamp}-${stage}.json`

   Write(archivePath, runState)
   ```
```

---

## ü§ñ Phase 4: Agent Updates

### 4.1 Update All 5 Agents

**Files to update:**
- `.claude/agents/architect.md`
- `.claude/agents/researcher.md`
- `.claude/agents/builder.md`
- `.claude/agents/qa.md`
- `.claude/agents/analyst.md`

**Add to SESSION START in each:**

```markdown
## SESSION START (MANDATORY)

**Read files in this order:**

1. **Project Context (ALWAYS FIRST!):**
   ```
   ${project_path}/.context/SYSTEM-CONTEXT.md
   ```
   This contains:
   - Services stack (Telegram, n8n, Supabase, OpenAI)
   - Database schema (tables, RPCs)
   - Workflow structure (nodes, phases)
   - Critical rules (NO signatures, etc.)
   - Applied learnings (last 10 + project-specific)
   - Active tasks (from TODO.md)
   - Common gotchas

2. **Agent Instructions:**
   ```
   .claude/agents/[agent].md
   ```

3. **Session State:**
   ```
   ${project_path}/.n8n/run_state.json
   ```

4. **Agent-Scoped Index (if applicable):**
   - Architect: `docs/learning/indexes/architect_patterns.md`
   - Researcher: `docs/learning/indexes/researcher_nodes.md`
   - Builder: `docs/learning/indexes/builder_gotchas.md`
   - QA: `docs/learning/indexes/qa_validation.md`
   - Analyst: `docs/learning/indexes/analyst_learnings.md`

**NEVER read full ARCHITECTURE.md or LEARNINGS.md directly!**
**SYSTEM-CONTEXT.md contains everything you need in 1,500-2,000 tokens.**
```

---

## üß™ Phase 5: Testing Plan

### 5.1 FoodTracker Migration Test

**Steps:**

1. **Run migration script:**
   ```bash
   cd /Users/sergey/Projects/ClaudeN8N
   ./scripts/migrate-to-distributed.sh \
     /Users/sergey/Projects/MultiBOT/bots/food-tracker \
     sw3Qs3Fe3JahEbbW
   ```

2. **Verify structure:**
   ```bash
   cd /Users/sergey/Projects/MultiBOT/bots/food-tracker
   tree -L 2 .n8n .context
   ```

   Expected:
   ```
   .n8n
   ‚îú‚îÄ‚îÄ README.md
   ‚îú‚îÄ‚îÄ canonical.json
   ‚îú‚îÄ‚îÄ run_state.json
   ‚îú‚îÄ‚îÄ history/
   ‚îî‚îÄ‚îÄ agent_results/

   .context
   ‚îú‚îÄ‚îÄ sources.json
   ‚îî‚îÄ‚îÄ context-version.json
   ```

3. **Generate initial SYSTEM-CONTEXT.md:**
   ```bash
   /orch refresh context
   ```

4. **Verify SYSTEM-CONTEXT.md:**
   ```bash
   cat .context/SYSTEM-CONTEXT.md
   wc -w .context/SYSTEM-CONTEXT.md  # Should be ~1,000-1,500 words
   ```

5. **Test agent read:**
   ```bash
   /orch test simple task
   ```

   Verify agents read SYSTEM-CONTEXT.md first (check logs).

6. **Test auto-update:**
   ```bash
   # Make a change (add learning, update TODO)
   echo "- [x] Test task" >> TODO.md

   # Complete a session
   /orch finalize session

   # Verify context updated
   git diff .context/SYSTEM-CONTEXT.md
   ```

### 5.2 Validation Checklist

- [ ] Migration script runs without errors
- [ ] All files copied to project/.n8n/
- [ ] sources.json created with correct project details
- [ ] SYSTEM-CONTEXT.md generated (<2,000 tokens)
- [ ] Agents read SYSTEM-CONTEXT.md first
- [ ] Context auto-updates on session complete
- [ ] Git commit created for context updates
- [ ] Old ClaudeN8N/memory/ files unchanged (backup preserved)

---

## üîô Phase 6: Rollback Plan

### If Migration Fails

**Rollback steps:**

1. **Restore orchestrator:**
   ```bash
   git checkout .claude/commands/orch.md
   ```

2. **Restore agents:**
   ```bash
   git checkout .claude/agents/*.md
   ```

3. **Keep old memory/ structure:**
   - ClaudeN8N/memory/ unchanged
   - Projects work as before

4. **Remove project/.n8n/ folders:**
   ```bash
   rm -rf /Users/sergey/Projects/MultiBOT/bots/food-tracker/.n8n
   rm -rf /Users/sergey/Projects/MultiBOT/bots/food-tracker/.context
   ```

**No data loss:**
- Original files in ClaudeN8N/memory/ preserved
- Git history allows full rollback

---

## üìä Phase 7: Benefits Verification

### Token Economy Test

**Before migration:**
```bash
# Agent reads full ARCHITECTURE.md
Token count: ~10,000 tokens
```

**After migration:**
```bash
# Agent reads SYSTEM-CONTEXT.md
Token count: ~1,800 tokens

Savings: 8,200 tokens (82%) per agent call
```

### Portability Test

**Before:**
```bash
# Cannot backup FoodTracker alone
# Need ClaudeN8N/memory/ + MultiBOT/bots/food-tracker
```

**After:**
```bash
# Single folder backup
tar -czf foodtracker-backup.tar.gz \
  /Users/sergey/Projects/MultiBOT/bots/food-tracker

# Contains: code + workflow state + context
```

---

## üìÖ Implementation Timeline

### Day 1: Preparation (1 hour)
- [x] Create migration plan (this document)
- [ ] Create templates in .claude/templates/
- [ ] Write migration script
- [ ] Review with user

### Day 2: Implementation (2 hours)
- [ ] Update Analyst agent (context manager role)
- [ ] Update Orchestrator (new file paths)
- [ ] Update all 5 agents (SYSTEM-CONTEXT.md first)
- [ ] Test on FoodTracker

### Day 3: Testing (1 hour)
- [ ] Run full migration test
- [ ] Verify token savings
- [ ] Check auto-update works
- [ ] User acceptance testing

---

## ‚úÖ Success Criteria

1. **FoodTracker fully migrated:**
   - .n8n/ folder with all data
   - .context/ folder with SYSTEM-CONTEXT.md
   - sources.json configured

2. **Agents use new structure:**
   - Read SYSTEM-CONTEXT.md first
   - Find files in project/.n8n/
   - No references to ClaudeN8N/memory/

3. **Auto-update works:**
   - Analyst updates context on session complete
   - Context version increments
   - Git commits created

4. **Token savings verified:**
   - Agent reads <2,000 tokens (vs 10,000)
   - 82% savings confirmed

5. **User happy:**
   - System feels more organized
   - Projects are portable
   - Context always fresh

---

## üöÄ Next Steps

**User Decision:**

1. **Review this plan** - Any changes needed?
2. **Approve migration** - Ready to start?
3. **Test on FoodTracker first** - Safe to proceed?

**Then:**
- Phase 1: Create templates (30 min)
- Phase 2: Update Analyst (30 min)
- Phase 3-4: Update Orchestrator + Agents (1 hour)
- Phase 5: Migration + Testing (1 hour)

**Total: ~3 hours for complete system upgrade**

---

**Created by:** Claude Code (Sonnet 4.5)
**Date:** 2025-12-09
**Status:** ‚è≥ Awaiting user approval
