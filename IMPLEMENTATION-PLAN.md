# –ü–õ–ê–ù –í–ù–ï–î–†–ï–ù–ò–Ø: –ö–æ–Ω—Ç–µ–∫—Å—Ç + Surgical Edits + Enforcement

> **–î–∞—Ç–∞:** 2025-12-15
> **–î–ª—è:** –°–ª–µ–¥—É—é—â–∏–π –±–æ—Ç (–Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è)
> **–í—Ä–µ–º—è:** ~5-6 —á–∞—Å–æ–≤
> **–¶–µ–ª—å:** –ê–≥–µ–Ω—Ç—ã –ø–æ–Ω–∏–º–∞—é—Ç –ó–ê–ß–ï–ú/–ü–û–ß–ï–ú–£, Builder –Ω–µ –ª–æ–º–∞–µ—Ç workflow

---

## –ü–†–û–ë–õ–ï–ú–ê (–∑–∞—á–µ–º —ç—Ç–æ –¥–µ–ª–∞–µ–º)

–ê–≥–µ–Ω—Ç—ã —Ç–µ—Ä—è—é—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –ª–æ–º–∞—é—Ç —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —á–∞—Å—Ç–∏ workflow:

1. **–ù–µ –∑–Ω–∞—é—Ç –ó–ê–ß–ï–ú** - Builder –≤–∏–¥–∏—Ç –Ω–æ–¥—ã, –Ω–æ –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç –∑–∞—á–µ–º Telegram, –∑–∞—á–µ–º Supabase, –∑–∞—á–µ–º Memory
2. **–ù–µ –∑–Ω–∞—é—Ç –ü–û–ß–ï–ú–£** - Builder –Ω–µ –∑–Ω–∞–µ—Ç –ø–æ—á–µ–º—É Memory ‚Üí AI Agent, –ø–æ—á–µ–º—É jsonBody –∑–∞–ø—Ä–µ—â–µ–Ω
3. **–õ–æ–º–∞—é—Ç —Å–ª—É—á–∞–π–Ω–æ** - Builder –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤–µ—Å—å workflow (58 –Ω–æ–¥), –º–µ–Ω—è–µ—Ç 1, —Å–ª—É—á–∞–π–Ω–æ –ø–æ—Ä—Ç–∏—Ç –¥—Ä—É–≥–∏–µ
4. **–ü–æ–≤—Ç–æ—Ä—è—é—Ç –æ—à–∏–±–∫–∏** - v516 –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –æ—à–∏–±–∫—É v432 –ø–æ—Ç–æ–º—É —á—Ç–æ –Ω–µ –≤–∏–¥–∏—Ç –∏—Å—Ç–æ—Ä–∏—é

---

## –ß–¢–û –°–û–ó–î–ê–Å–ú

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤:

```
{project}/.context/                          # –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞ (FoodTracker)
‚îú‚îÄ‚îÄ 1-STRATEGY.md                            # –ú–∏—Å—Å–∏—è, —Ü–µ–ª–∏, –≥—Ä–∞–Ω–∏—Ü—ã
‚îú‚îÄ‚îÄ 2-INDEX.md                               # –ù–∞–≤–∏–≥–∞—Ü–∏—è + Protected Nodes
‚îú‚îÄ‚îÄ architecture/
‚îÇ   ‚îú‚îÄ‚îÄ flow.md                              # Data flow diagram
‚îÇ   ‚îú‚îÄ‚îÄ decisions/                           # ADRs (Architecture Decision Records)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 001-ai-agent-memory.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 002-inject-context.md
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 003-telegram-sync.md
‚îÇ   ‚îú‚îÄ‚îÄ services/                            # Service Playbooks
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ telegram.md
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ supabase.md
‚îÇ   ‚îî‚îÄ‚îÄ nodes/                               # Node Intent Cards (–∫—Ä–∏—Ç–∏—á–Ω—ã–µ –Ω–æ–¥—ã)
‚îÇ       ‚îî‚îÄ‚îÄ ai-agent.md
‚îî‚îÄ‚îÄ technical/
    ‚îî‚îÄ‚îÄ state.json                           # –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (lazy load)

.claude/agents/shared/                        # –û–±—â–∏–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤
‚îú‚îÄ‚îÄ anti-hallucination.md                    # L-075
‚îú‚îÄ‚îÄ project-context.md                       # –ö–∞–∫ –∑–∞–≥—Ä—É–∂–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç
‚îú‚îÄ‚îÄ surgical-edits.md                        # Partial updates –ø—Ä–æ—Ç–æ–∫–æ–ª
‚îî‚îÄ‚îÄ context-update.md                        # –ü—Ä–æ—Ç–æ–∫–æ–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

.claude/hooks/                               # Enforcement
‚îú‚îÄ‚îÄ block-full-update.md                     # –ë–ª–æ–∫–∏—Ä—É–µ—Ç full workflow update
‚îî‚îÄ‚îÄ enforce-context-update.md                # Analyst –æ–±—è–∑–∞–Ω –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç
```

---

## –ü–û–†–Ø–î–û–ö –í–´–ü–û–õ–ù–ï–ù–ò–Ø

### –§–ê–ó–ê 0: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (10 –º–∏–Ω)

```bash
# 1. –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
mkdir -p /Users/sergey/Projects/MultiBOT/bots/food-tracker/.context/architecture/decisions
mkdir -p /Users/sergey/Projects/MultiBOT/bots/food-tracker/.context/architecture/services
mkdir -p /Users/sergey/Projects/MultiBOT/bots/food-tracker/.context/architecture/nodes
mkdir -p /Users/sergey/Projects/MultiBOT/bots/food-tracker/.context/technical
mkdir -p /Users/sergey/Projects/ClaudeN8N/.claude/agents/shared
mkdir -p /Users/sergey/Projects/ClaudeN8N/.claude/hooks

# 2. –£–¥–∞–ª–∏—Ç—å –º—É—Å–æ—Ä–Ω—ã–µ cycle —Ñ–∞–π–ª—ã
find /Users/sergey/Projects/ClaudeN8N/memory/agent_results -name "*_cycle*.json" -delete
find /Users/sergey/Projects/MultiBOT/bots/food-tracker/.n8n -name "*_cycle*.json" -delete 2>/dev/null || true
```

---

### –§–ê–ó–ê 1: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞ FoodTracker (1.5 —á–∞—Å–∞)

#### –§–∞–π–ª 1: `.context/1-STRATEGY.md`

```markdown
# FoodTracker - –°—Ç—Ä–∞—Ç–µ–≥–∏—è

## –ú–∏—Å—Å–∏—è
Telegram –±–æ—Ç –¥–ª—è —Ç—Ä–µ–∫–∏–Ω–≥–∞ –µ–¥—ã —á–µ—Ä–µ–∑ —Ä–∞–∑–≥–æ–≤–æ—Ä —Å AI. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç/–ø–∏—à–µ—Ç/—Ñ–æ—Ç–∫–∞–µ—Ç –µ–¥—É ‚Üí –±–æ—Ç –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç.

## –ì–ª–∞–≤–Ω—ã–µ —Ü–µ–ª–∏
1. **–ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥** - –≥–æ–ª–æ—Å, —Ñ–æ—Ç–æ, —Ç–µ–∫—Å—Ç ‚Üí "—Å–∫–∞–∑–∞–ª ‚Üí –∑–∞–ø–∏—Å–∞–ª–æ—Å—å"
2. **–£–º–Ω—ã–π –∞–Ω–∞–ª–∏–∑** - AI –ø–æ–Ω–∏–º–∞–µ—Ç "—è–∏—á–Ω–∏—Ü–∞", "200–≥ –∫—É—Ä–∏—Ü—ã", —Ñ–æ—Ç–æ –µ–¥—ã
3. **–ü–æ–ª–µ–∑–Ω—ã–µ –æ—Ç—á–µ—Ç—ã** - –¥–µ–Ω—å, –Ω–µ–¥–µ–ª—è, –º–µ—Å—è—Ü —Å —Ç—Ä–µ–Ω–¥–∞–º–∏

## –ß—Ç–æ –ù–ï –¥–µ–ª–∞–µ–º (–≥—Ä–∞–Ω–∏—Ü—ã)
- ‚ùå –ù–ï —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–∫–µ—Ä (–Ω–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫)
- ‚ùå –ù–ï –∫–Ω–∏–≥–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤
- ‚ùå –ù–ï –º—É–ª—å—Ç–∏—é–∑–µ—Ä (1 –±–æ—Ç = 1 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Sergey)
- ‚ùå –ù–ï –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (—Ç–æ–ª—å–∫–æ Telegram)

## –ö—Ä–∏—Ç–∏—á–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- –ë–æ—Ç –î–û–õ–ñ–ï–ù –æ—Ç–≤–µ—á–∞—Ç—å < 3 —Å–µ–∫ (–∏–Ω–∞—á–µ —é–∑–µ—Ä —É–π–¥–µ—Ç)
- AI –î–û–õ–ñ–ï–ù –ø–æ–º–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ (Memory node!)
- –î–∞–Ω–Ω—ã–µ –î–û–õ–ñ–ù–´ —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤ Supabase (–Ω–µ —Ç–µ—Ä—è—Ç—å!)
- –û—Ç—á–µ—Ç—ã –î–û–õ–ñ–ù–´ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç—Ä–µ–Ω–¥—ã (—Ü–µ–Ω–Ω–æ—Å—Ç—å –±–æ—Ç–∞)

## –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- –ò–º—è: Sergey
- –Ø–∑—ã–∫: –†—É—Å—Å–∫–∏–π
- Telegram ID: 682776858
- –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: Europe/Warsaw
```

#### –§–∞–π–ª 2: `.context/2-INDEX.md`

```markdown
# –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É FoodTracker

## –î–ª—è –í–°–ï–• –∞–≥–µ–Ω—Ç–æ–≤ (—á–∏—Ç–∞—Ç—å –ø–µ—Ä–≤—ã–º!)
1. `1-STRATEGY.md` - –∑–∞—á–µ–º –ø—Ä–æ–µ–∫—Ç, —Ü–µ–ª–∏, –≥—Ä–∞–Ω–∏—Ü—ã

## –î–ª—è Architect
- `architecture/flow.md` - –∫–∞–∫ –¥–∞–Ω–Ω—ã–µ –∏–¥—É—Ç

## –î–ª—è Researcher
- `architecture/flow.md` - –æ–±–∑–æ—Ä –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- `architecture/services/*.md` - –µ—Å–ª–∏ –∏—â–µ—à—å –ø–æ —Å–µ—Ä–≤–∏—Å—É
- `architecture/decisions/*.md` - –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è —Ä–µ—à–µ–Ω–∏–π

## –î–ª—è Builder (‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û!)

**–ü–ï–†–ï–î –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –õ–Æ–ë–û–ô –Ω–æ–¥—ã:**
1. –ù–∞–π–¥–∏ –Ω–æ–¥—É –≤ —Ç–∞–±–ª–∏—Ü–µ –Ω–∏–∂–µ
2. –ü—Ä–æ—á–∏—Ç–∞–π –µ—ë —Ñ–∞–π–ª (ADR –∏–ª–∏ Intent Card)
3. –ü—Ä–æ–≤–µ—Ä—å —Å–µ–∫—Ü–∏—é "DO NOT TOUCH"
4. –ï—Å–ª–∏ –º–µ–Ω—è–µ—à—å protected ‚Üí –°–ü–†–û–°–ò USER!

| –ù–æ–¥–∞ | –§–∞–π–ª | DO NOT TOUCH |
|------|------|--------------|
| AI Agent | `nodes/ai-agent.md` | Memory connection, jsonBody –≤ tools |
| Memory | `decisions/001-ai-agent-memory.md` | customKey='telegram_user_id' |
| Inject Context | `decisions/002-inject-context.md` | –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–ï–†–ï–î AI Agent |
| Switch | `decisions/003-telegram-sync.md` | –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π —Å BotFather! |
| Telegram Trigger | - | Webhook path |

## Protected Nodes (–ù–ï –£–î–ê–õ–Ø–¢–¨ –±–µ–∑ approval!)
- **Telegram Trigger** - —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞, –±–µ–∑ –Ω–µ—ë –±–æ—Ç –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
- **AI Agent** - –≥–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –±–µ–∑ –Ω–µ–≥–æ –±–æ—Ç –Ω–µ –¥—É–º–∞–µ—Ç
- **Memory** - –∏—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤, –±–µ–∑ –Ω–µ—ë AI –Ω–µ –ø–æ–º–Ω–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç
- **Switch** - —Ä–æ—É—Ç–µ—Ä, –±–µ–∑ –Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –¥–æ—Ö–æ–¥—è—Ç –¥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

## –î–ª—è QA
- `architecture/flow.md` - –≥–¥–µ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å
- `2-INDEX.md` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å protected nodes –Ω–µ —É–¥–∞–ª–µ–Ω—ã

## –î–ª—è Analyst
- –í–°–ï —Ñ–∞–π–ª—ã (–¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

## –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
| –í–µ—Ä—Å–∏—è | –ò–∑–º–µ–Ω–µ–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|--------|-----------|--------|
| v514 | –î–æ–±–∞–≤–ª–µ–Ω operation=sendMessage | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| v506 | –£–¥–∞–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ /start | ‚ö†Ô∏è –ù–∞–º–µ—Ä–µ–Ω–Ω–æ |
| v436 | –î–æ–±–∞–≤–ª–µ–Ω /welcome routing | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| v434 | –£–î–ê–õ–ï–ù jsonBody (–æ—Ç–∫–∞—Ç v432) | ‚úÖ –ö—Ä–∏—Ç–∏—á–Ω—ã–π —Ñ–∏–∫—Å |
| v432 | –î–æ–±–∞–≤–ª–µ–Ω jsonBody ‚Üí –ë–û–¢ –ó–ê–ú–û–õ–ß–ê–õ | ‚ùå –ò–Ω—Ü–∏–¥–µ–Ω—Ç |

---
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-12-15
**–í–µ—Ä—Å–∏—è workflow:** v514
```

#### –§–∞–π–ª 3: `.context/architecture/flow.md`

```markdown
# FoodTracker - Data Flow

## –û–±—â–∞—è —Å—Ö–µ–º–∞

```
Telegram User
     ‚îÇ
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Telegram   ‚îÇ ‚óÑ‚îÄ‚îÄ Webhook: /webhook/food-tracker/{id}
‚îÇ   Trigger   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Switch    ‚îÇ ‚óÑ‚îÄ‚îÄ 11 –ø—É—Ç–µ–π –ø–æ message_type + commands
‚îÇ  (Router)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îú‚îÄ‚îÄ text ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ Inject Context ‚îÄ‚îÄ‚ñ∫ AI Agent ‚îÄ‚îÄ‚ñ∫ Strip Signature ‚îÄ‚îÄ‚ñ∫ Reply
     ‚îÇ
     ‚îú‚îÄ‚îÄ voice ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ Whisper ‚îÄ‚îÄ‚ñ∫ Inject Context ‚îÄ‚îÄ‚ñ∫ AI Agent ‚îÄ‚îÄ‚ñ∫ Reply
     ‚îÇ
     ‚îú‚îÄ‚îÄ photo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ Barcode? ‚îÄ‚îÄ‚ñ∫ OpenFoodFacts/UPC/Vision ‚îÄ‚îÄ‚ñ∫ AI Agent ‚îÄ‚îÄ‚ñ∫ Reply
     ‚îÇ
     ‚îú‚îÄ‚îÄ /day ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ Execute Sub-workflow ‚îÄ‚îÄ‚ñ∫ Reply
     ‚îú‚îÄ‚îÄ /week ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ Execute Sub-workflow ‚îÄ‚îÄ‚ñ∫ Reply
     ‚îú‚îÄ‚îÄ /month ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ Execute Sub-workflow ‚îÄ‚îÄ‚ñ∫ Reply
     ‚îî‚îÄ‚îÄ /welcome ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ Execute Sub-workflow ‚îÄ‚îÄ‚ñ∫ Reply
```

## –î–µ—Ç–∞–ª—å–Ω–æ: Text Message Flow

```
1. User: "–Ø–∏—á–Ω–∏—Ü–∞ –Ω–∞ –∑–∞–≤—Ç—Ä–∞–∫"
   ‚îÇ
   ‚ñº
2. Telegram Trigger
   ‚îÇ Output: { message: { text: "–Ø–∏—á–Ω–∏—Ü–∞ –Ω–∞ –∑–∞–≤—Ç—Ä–∞–∫", from: { id: 682776858 } } }
   ‚ñº
3. Switch (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç: –µ—Å—Ç—å message.text?)
   ‚îÇ Route: "text" branch
   ‚ñº
4. Inject Context (Code Node)
   ‚îÇ –î–æ–±–∞–≤–ª—è–µ—Ç: date, timezone, user_id –≤ SYSTEM prompt
   ‚îÇ Output: { message: "...", context: { date: "2025-12-15", tz: "Europe/Warsaw" } }
   ‚ñº
5. AI Agent
   ‚îÇ ‚îú‚îÄ‚îÄ –ß–∏—Ç–∞–µ—Ç Memory (–∏—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)
   ‚îÇ ‚îú‚îÄ‚îÄ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
   ‚îÇ ‚îú‚îÄ‚îÄ –í—ã–∑—ã–≤–∞–µ—Ç Tool "Add Meal" ‚Üí HTTP Request ‚Üí Supabase
   ‚îÇ ‚îî‚îÄ‚îÄ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç
   ‚îÇ Output: "–ó–∞–ø–∏—Å–∞–ª —è–∏—á–Ω–∏—Ü—É –Ω–∞ –∑–∞–≤—Ç—Ä–∞–∫! üç≥\n\n-- FoodTracker Bot"
   ‚ñº
6. Strip Signature (Code Node)
   ‚îÇ –£–±–∏—Ä–∞–µ—Ç: "-- FoodTracker Bot"
   ‚îÇ Output: "–ó–∞–ø–∏—Å–∞–ª —è–∏—á–Ω–∏—Ü—É –Ω–∞ –∑–∞–≤—Ç—Ä–∞–∫! üç≥"
   ‚ñº
7. Telegram Send Message
   ‚îÇ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
   ‚ñº
User –≤–∏–¥–∏—Ç: "–ó–∞–ø–∏—Å–∞–ª —è–∏—á–Ω–∏—Ü—É –Ω–∞ –∑–∞–≤—Ç—Ä–∞–∫! üç≥"
```

## –ö—Ä–∏—Ç–∏—á–Ω—ã–µ —Ç–æ—á–∫–∏ (–≥–¥–µ –Ω–µ–ª—å–∑—è –æ—à–∏–±–∏—Ç—å—Å—è)

### –¢–æ—á–∫–∞ 1: Memory ‚Üí AI Agent
```
‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: Memory –î–û–õ–ñ–ï–ù –±—ã—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ AI Agent!

Memory Node ‚îÄ‚îÄ(memory_input)‚îÄ‚îÄ‚ñ∫ AI Agent

–ë–µ–∑ —ç—Ç–æ–≥–æ: AI –Ω–µ –ø–æ–º–Ω–∏—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º—ã: User –≥–æ–≤–æ—Ä–∏—Ç "–æ–±–Ω–æ–≤–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–µ" ‚Üí AI –Ω–µ –∑–Ω–∞–µ—Ç —á—Ç–æ "–ø–æ—Å–ª–µ–¥–Ω–µ–µ"
```

### –¢–æ—á–∫–∞ 2: Inject Context ‚Üí AI Agent
```
‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: Inject Context –î–û–õ–ñ–ï–ù –±—ã—Ç—å –ü–ï–†–ï–î AI Agent!

Inject Context ‚îÄ‚îÄ‚ñ∫ AI Agent

–ë–µ–∑ —ç—Ç–æ–≥–æ: AI –Ω–µ –∑–Ω–∞–µ—Ç —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –∏ timezone
–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º—ã: User —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç "—á—Ç–æ —è –µ–ª —Å–µ–≥–æ–¥–Ω—è?" ‚Üí AI –Ω–µ –∑–Ω–∞–µ—Ç –∫–∞–∫–æ–π —Å–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å
```

### –¢–æ—á–∫–∞ 3: Switch ‚Üî BotFather
```
‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ö–æ–º–∞–Ω–¥—ã –≤ Switch –î–û–õ–ñ–ù–´ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å BotFather!

Switch cases: /day, /week, /month, /welcome, /help
BotFather commands: –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ç–µ –∂–µ!

–ë–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: User –≤–∏–¥–∏—Ç –∫–æ–º–∞–Ω–¥—É –≤ –º–µ–Ω—é Telegram, –Ω–æ –±–æ—Ç –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
```

### –¢–æ—á–∫–∞ 4: AI Agent Tools ‚Üí HTTP Request
```
‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: Tools –∏—Å–ø–æ–ª—å–∑—É—é—Ç parametersBody, –ù–ï jsonBody!

Tool Config:
‚úÖ parametersBody: { meal_name: "={{ $fromAI('meal_name') }}" }
‚ùå jsonBody: { ... }  ‚Üê –ó–ê–ü–†–ï–©–ï–ù–û! –°–º. –∏–Ω—Ü–∏–¥–µ–Ω—Ç v432

n8n AI Agent –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò —Å—Ç—Ä–æ–∏—Ç JSON –∏–∑ parametersBody.
jsonBody –õ–û–ú–ê–ï–¢ —ç—Ç—É –∞–≤—Ç–æ–º–∞—Ç–∏–∫—É ‚Üí 400 errors ‚Üí –±–æ—Ç –º–æ–ª—á–∏—Ç.
```
```

#### –§–∞–π–ª 4: `.context/architecture/decisions/001-ai-agent-memory.md`

```markdown
# ADR-001: AI Agent + Memory Connection

## –°—Ç–∞—Ç—É—Å
‚úÖ –ü—Ä–∏–Ω—è—Ç–æ | üî¥ –ö–†–ò–¢–ò–ß–ù–û - –Ω–µ —É–¥–∞–ª—è—Ç—å!

## –ö–æ–Ω—Ç–µ–∫—Å—Ç
FoodTracker - —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π –±–æ—Ç. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–µ–¥—É—Ç –¥–∏–∞–ª–æ–≥:
- "–ó–∞–ø–∏—Å–∞–ª —è–∏—á–Ω–∏—Ü—É" ‚Üí "–û–±–Ω–æ–≤–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –Ω–∞ 2 —è–π—Ü–∞" (–∫–∞–∫–æ–µ "–ø–æ—Å–ª–µ–¥–Ω–µ–µ"?)
- "–°–∫–æ–ª—å–∫–æ —è —Å—ä–µ–ª —Å–µ–≥–æ–¥–Ω—è?" (–Ω—É–∂–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è)

**–í–æ–ø—Ä–æ—Å:** –ö–∞–∫ AI –ø–æ–º–Ω–∏—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è?

## –†–µ—à–µ–Ω–∏–µ
**Memory Node** –ø–æ–¥–∫–ª—é—á–µ–Ω –Ω–∞–ø—Ä—è–º—É—é –∫ **AI Agent** —á–µ—Ä–µ–∑ `memory_input`.

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Memory:
- **customKey:** `telegram_user_id` (–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–µ—Å—Å–∏–∏ –ø–æ —é–∑–µ—Ä—É)
- **Storage:** PostgreSQL (Supabase)
- **Window:** –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å–æ–æ–±—â–µ–Ω–∏–π

## –°—Ö–µ–º–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–ù–ï –ú–ï–ù–Ø–¢–¨!)
```
Supabase (—Ö—Ä–∞–Ω–∏—Ç –∏—Å—Ç–æ—Ä–∏—é)
        ‚îÇ
        ‚ñº
   Memory Node
   customKey: telegram_user_id
        ‚îÇ
        ‚îÇ (memory_input)
        ‚ñº
    AI Agent
```

## DO NOT TOUCH! (–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø–æ–ª—è)

| –ü–æ–ª–µ | –ó–Ω–∞—á–µ–Ω–∏–µ | –ü–æ—á–µ–º—É –Ω–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å |
|------|----------|---------------------|
| Memory ‚Üí AI Agent connection | –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ | AI –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç –∏—Å—Ç–æ—Ä–∏—é |
| customKey | `telegram_user_id` | –°–µ—Å—Å–∏–∏ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —ç—Ç–æ–º—É –∫–ª—é—á—É |
| Memory node existence | –î–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å | –ë–µ–∑ –Ω–µ–≥–æ –Ω–µ—Ç –ø–∞–º—è—Ç–∏ |

## –ò—Å—Ç–æ—Ä–∏—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤

### v442 (2025-12-08) - –°–ï–°–°–ò–ò –°–õ–û–ú–ê–õ–ò–°–¨
- **–ß—Ç–æ —Å–¥–µ–ª–∞–ª–∏:** –ò–∑–º–µ–Ω–∏–ª–∏ customKey —Å `telegram_user_id` –Ω–∞ `user_id`
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ—Ç–µ—Ä—è–ª–∏ –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤
- **–û—Ç–∫–∞—Ç:** v444 (–≤–µ—Ä–Ω—É–ª–∏ `telegram_user_id`)
- **–£—Ä–æ–∫:** customKey - —á–∞—Å—Ç—å —Å—Ö–µ–º—ã, –º–µ–Ω—è—Ç—å = –ø–æ—Ç–µ—Ä—è—Ç—å –≤—Å–µ —Å–µ—Å—Å–∏–∏

### v432 (2025-12-11) - –ë–û–¢ –ó–ê–ú–û–õ–ß–ê–õ
- **–ß—Ç–æ —Å–¥–µ–ª–∞–ª–∏:** –î–æ–±–∞–≤–∏–ª–∏ `jsonBody` –≤ Tools 12-14 (Search, Update, Delete Meal)
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** HTTP Request –≤–æ–∑–≤—Ä–∞—â–∞–ª 400 ‚Üí AI Agent –ø–∞–¥–∞–ª ‚Üí –±–æ—Ç –º–æ–ª—á–∞–ª
- **–û—Ç–∫–∞—Ç:** v434 (—É–¥–∞–ª–∏–ª–∏ jsonBody, –æ—Å—Ç–∞–≤–∏–ª–∏ —Ç–æ–ª—å–∫–æ parametersBody)
- **–£—Ä–æ–∫:** n8n AI Agent —Å–∞–º —Å—Ç—Ä–æ–∏—Ç body –∏–∑ parametersBody. jsonBody –ª–æ–º–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∫—É!

## –ü—Ä–∞–≤–∏–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### ‚úÖ –ú–û–ñ–ù–û:
- –î–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ Tools –∫ AI Agent
- –ò–∑–º–µ–Ω—è—Ç—å System Prompt
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (temperature, etc)

### ‚ùå –ù–ï–õ–¨–ó–Ø (–±–µ–∑ approval):
- –£–¥–∞–ª—è—Ç—å Memory node
- –ú–µ–Ω—è—Ç—å customKey
- –†–∞–∑—Ä—ã–≤–∞—Ç—å connection Memory ‚Üí AI Agent
- –î–æ–±–∞–≤–ª—è—Ç—å jsonBody –∫ Tools
- –í—Å—Ç–∞–≤–ª—è—Ç—å –Ω–æ–¥—ã –º–µ–∂–¥—É Memory –∏ AI Agent
```

#### –§–∞–π–ª 5: `.context/architecture/decisions/002-inject-context.md`

```markdown
# ADR-002: Inject Context Pattern

## –°—Ç–∞—Ç—É—Å
‚úÖ –ü—Ä–∏–Ω—è—Ç–æ

## –ö–æ–Ω—Ç–µ–∫—Å—Ç
AI Agent –¥–æ–ª–∂–µ–Ω –∑–Ω–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç: –∫–∞–∫–æ–π —Å–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å, –∫–∞–∫–æ–π timezone —É —é–∑–µ—Ä–∞.
–ë–µ–∑ —ç—Ç–æ–≥–æ AI –Ω–µ –º–æ–∂–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ "—á—Ç–æ —è –µ–ª —Å–µ–≥–æ–¥–Ω—è?".

## –†–µ—à–µ–Ω–∏–µ
**Code Node "Inject Context"** –¥–æ–±–∞–≤–ª—è–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ SYSTEM —á–∞—Å—Ç—å –ø—Ä–æ–º–ø—Ç–∞ –ü–ï–†–ï–î AI Agent.

```javascript
// Inject Context - Code Node
const today = DateTime.now().setZone('Europe/Warsaw');
const systemPrefix = `
CURRENT DATE: ${today.toFormat('yyyy-MM-dd')}
CURRENT TIME: ${today.toFormat('HH:mm')}
TIMEZONE: Europe/Warsaw
USER_ID: ${$input.item.json.message.from.id}
`;

return {
  ...items[0].json,
  systemPrefix: systemPrefix
};
```

## –°—Ö–µ–º–∞ (–ù–ï –ú–ï–ù–Ø–¢–¨ –ø–æ—Ä—è–¥–æ–∫!)
```
Switch ‚îÄ‚îÄ‚ñ∫ Inject Context ‚îÄ‚îÄ‚ñ∫ AI Agent
              ‚îÇ
              ‚îî‚îÄ‚îÄ –î–æ–±–∞–≤–ª—è–µ—Ç: date, time, timezone, user_id
```

## DO NOT TOUCH!

| –ß—Ç–æ | –ü–æ—á–µ–º—É |
|-----|--------|
| –ü–æ—Ä—è–¥–æ–∫: Inject ‚Üí AI Agent | AI –¥–æ–ª–∂–µ–Ω –ü–û–õ–£–ß–ò–¢–¨ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ |
| Timezone: Europe/Warsaw | –ü—Ä–∏–≤—è–∑–∞–Ω –∫ –ª–æ–∫–∞—Ü–∏–∏ —é–∑–µ—Ä–∞ |
| Fields: date, time, user_id | AI –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤ –ø—Ä–æ–º–ø—Ç–µ |

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
- L-089: Code Node Injection (LEARNINGS.md)
- L-095: Timezone-aware dates
```

#### –§–∞–π–ª 6: `.context/architecture/decisions/003-telegram-sync.md`

```markdown
# ADR-003: Telegram Commands Sync

## –°—Ç–∞—Ç—É—Å
‚úÖ –ü—Ä–∏–Ω—è—Ç–æ

## –ö–æ–Ω—Ç–µ–∫—Å—Ç
Telegram –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã –≤ –º–µ–Ω—é –±–æ—Ç–∞ (—Å–∏–Ω—è—è –∫–Ω–æ–ø–∫–∞ "/" —Ä—è–¥–æ–º —Å –ø–æ–ª–µ–º –≤–≤–æ–¥–∞).
–≠—Ç–∏ –∫–æ–º–∞–Ω–¥—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –≤ BotFather.
Switch Node —Ä–æ—É—Ç–∏—Ç –∫–æ–º–∞–Ω–¥—ã –Ω–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏.

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –µ—Å—Ç—å –≤ BotFather, –Ω–æ –Ω–µ—Ç –≤ Switch ‚Üí —é–∑–µ—Ä confused.

## –†–µ—à–µ–Ω–∏–µ
**Switch Node** –∏ **BotFather** –î–û–õ–ñ–ù–´ –±—ã—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã.

### –¢–µ–∫—É—â–∏–µ –∫–æ–º–∞–Ω–¥—ã:

| –ö–æ–º–∞–Ω–¥–∞ | Switch Case | BotFather | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-------------|-----------|----------|
| /day | ‚úÖ | ‚úÖ | –û—Ç—á–µ—Ç –∑–∞ –¥–µ–Ω—å |
| /week | ‚úÖ | ‚úÖ | –û—Ç—á–µ—Ç –∑–∞ –Ω–µ–¥–µ–ª—é |
| /month | ‚úÖ | ‚úÖ | –û—Ç—á–µ—Ç –∑–∞ –º–µ—Å—è—Ü |
| /welcome | ‚úÖ | ‚úÖ | –û–Ω–±–æ—Ä–¥–∏–Ω–≥ |
| /help | ‚úÖ | ‚úÖ | –ü–æ–º–æ—â—å |

### –ö–∞–∫ –æ–±–Ω–æ–≤–ª—è—Ç—å:

1. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã:**
   ```
   1. –î–æ–±–∞–≤–∏—Ç—å case –≤ Switch Node
   2. –°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ (–∏–ª–∏ Execute Sub-workflow)
   3. –û–±–Ω–æ–≤–∏—Ç—å BotFather: /setcommands
   4. –û–±–Ω–æ–≤–∏—Ç—å —ç—Ç–æ—Ç ADR
   ```

2. **–£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã:**
   ```
   1. –£–¥–∞–ª–∏—Ç—å –∏–∑ BotFather: /setcommands
   2. –£–¥–∞–ª–∏—Ç—å case –∏–∑ Switch Node
   3. –û–±–Ω–æ–≤–∏—Ç—å —ç—Ç–æ—Ç ADR
   ```

## DO NOT TOUCH!
- –ù–µ –¥–æ–±–∞–≤–ª—è–π –∫–æ–º–∞–Ω–¥—É –≤ Switch –±–µ–∑ BotFather
- –ù–µ —É–¥–∞–ª—è–π –∫–æ–º–∞–Ω–¥—É –∏–∑ Switch –±–µ–∑ BotFather

## –ò—Å—Ç–æ—Ä–∏—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤

### v506 (2025-12-12) - –Æ–ó–ï–†–´ CONFUSED
- **–ß—Ç–æ —Å–¥–µ–ª–∞–ª–∏:** –î–æ–±–∞–≤–∏–ª–∏ /welcome –≤ Switch, –∑–∞–±—ã–ª–∏ –≤ BotFather
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–ª–∞, –Ω–æ —é–∑–µ—Ä—ã –Ω–µ –≤–∏–¥–µ–ª–∏ –µ—ë –≤ –º–µ–Ω—é
- **–§–∏–∫—Å:** –î–æ–±–∞–≤–∏–ª–∏ –≤ BotFather
- **–£—Ä–æ–∫:** –í–°–ï–ì–î–ê —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å Switch ‚Üî BotFather
```

#### –§–∞–π–ª 7: `.context/architecture/services/telegram.md`

```markdown
# Service Playbook: Telegram Bot API

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å FoodTracker. –í—Å–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å —é–∑–µ—Ä–æ–º —á–µ—Ä–µ–∑ Telegram.

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| Bot Token | Credentials: "Telegram FoodTracker" |
| Webhook URL | `https://n8n.serhii.app/webhook/food-tracker/{id}` |
| Bot Username | @FoodTrackerSerhiiBot |

## –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –º–µ—Ç–æ–¥—ã API

| –ú–µ—Ç–æ–¥ | –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-------|------------------|------------|
| getUpdates | Telegram Trigger (webhook mode) | –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π |
| sendMessage | Telegram Send Message (8 –º–µ—Å—Ç) | –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ |
| sendPhoto | - | –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è |

## Rate Limits
- 30 —Å–æ–æ–±—â–µ–Ω–∏–π/—Å–µ–∫ –≤ –æ–¥–∏–Ω —á–∞—Ç
- 1 —Å–æ–æ–±—â–µ–Ω–∏–µ/—Å–µ–∫ –≤ –≥—Ä—É–ø–ø—É
- –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç 1:1, –ª–∏–º–∏—Ç—ã –Ω–µ –ø—Ä–æ–±–ª–µ–º–∞

## –ó–∞–≤–∏—Å–∏–º—ã–µ –Ω–æ–¥—ã

| –ù–æ–¥–∞ | –¢–∏–ø | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å |
|------|-----|-------------|
| Telegram Trigger | Webhook | üî¥ –ö–†–ò–¢–ò–ß–ù–û - —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ |
| Telegram Send Message | Action | üü° –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–µ–∑–¥–µ |
| Switch | Router | üî¥ –ö–†–ò–¢–ò–ß–ù–û - —Ä–æ—É—Ç–∏–Ω–≥ –∫–æ–º–∞–Ω–¥ |

## –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞

1. **Webhook path:** –ù–µ –º–µ–Ω—è—Ç—å –±–µ–∑ –ø–µ—Ä–µ–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ Telegram
2. **Credentials:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å "Telegram FoodTracker" –∏–∑ n8n
3. **Commands:** –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å BotFather (—Å–º. ADR-003)

## Troubleshooting

| –ü—Ä–æ–±–ª–µ–º–∞ | –ü—Ä–∏—á–∏–Ω–∞ | –†–µ—à–µ–Ω–∏–µ |
|----------|---------|---------|
| –ë–æ—Ç –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è | Webhook —Å–ª–æ–º–∞–Ω | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Telegram Trigger active |
| –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç | AI Agent –ø–∞–¥–∞–µ—Ç | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å execution logs |
| –ö–æ–º–∞–Ω–¥–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç | –ù–µ—Ç –≤ Switch | –î–æ–±–∞–≤–∏—Ç—å case –≤ Switch |
```

#### –§–∞–π–ª 8: `.context/architecture/services/supabase.md`

```markdown
# Service Playbook: Supabase

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
PostgreSQL –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è:
- –ü—Ä–∏–µ–º—ã –ø–∏—â–∏ (meals)
- –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ (Memory node)
- –Æ–∑–µ—Ä –¥–∞–Ω–Ω—ã–µ

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| Project | serhii-food-tracker |
| Credentials | "Supabase FoodTracker" –≤ n8n |
| API URL | https://xxx.supabase.co |

## –¢–∞–±–ª–∏—Ü—ã

| –¢–∞–±–ª–∏—Ü–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ |
|---------|------------|----------------|
| meals | –ü—Ä–∏–µ–º—ã –ø–∏—â–∏ | AI Agent Tools (Add/Search/Update/Delete Meal) |
| n8n_chat_histories | –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ | Memory Node |

## –°—Ö–µ–º–∞ meals:
```sql
CREATE TABLE meals (
  id UUID PRIMARY KEY,
  user_id BIGINT,           -- telegram_user_id
  meal_name TEXT,
  calories INT,
  protein FLOAT,
  carbs FLOAT,
  fat FLOAT,
  meal_time TIMESTAMP,
  created_at TIMESTAMP
);
```

## –ó–∞–≤–∏—Å–∏–º—ã–µ –Ω–æ–¥—ã

| –ù–æ–¥–∞ | –û–ø–µ—Ä–∞—Ü–∏—è | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å |
|------|----------|-------------|
| Tool 9: Add Meal | INSERT | üü° –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è |
| Tool 11: Search Meals | SELECT | üü° –ü–æ–∏—Å–∫ –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤ |
| Tool 12: Update Meal | UPDATE | üü° –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ |
| Tool 14: Delete Meal | DELETE | üü° –£–¥–∞–ª–µ–Ω–∏–µ |
| Memory Node | SELECT/INSERT | üî¥ –ö–†–ò–¢–ò–ß–ù–û - –∏—Å—Ç–æ—Ä–∏—è |

## –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞

1. **Credentials:** –¢–æ–ª—å–∫–æ "Supabase FoodTracker"
2. **user_id:** –í—Å–µ–≥–¥–∞ telegram_user_id (682776858)
3. **–ù–µ –¥–æ–±–∞–≤–ª—è—Ç—å jsonBody** –≤ HTTP Request –∫ Supabase (—Å–º. ADR-001)

## Troubleshooting

| –ü—Ä–æ–±–ª–µ–º–∞ | –ü—Ä–∏—á–∏–Ω–∞ | –†–µ—à–µ–Ω–∏–µ |
|----------|---------|---------|
| Meal –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è | –û—à–∏–±–∫–∞ –≤ HTTP Request | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å execution logs |
| Memory –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç | Supabase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å credentials |
| 400 error | jsonBody –¥–æ–±–∞–≤–ª–µ–Ω | –£–¥–∞–ª–∏—Ç—å jsonBody, –æ—Å—Ç–∞–≤–∏—Ç—å parametersBody |
```

#### –§–∞–π–ª 9: `.context/architecture/nodes/ai-agent.md`

```markdown
# Node Intent Card: AI Agent

## –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- **Node Name:** AI Agent
- **Node Type:** @n8n/n8n-nodes-langchain.agent
- **–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤ workflow:** –î–∞

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ì–ª–∞–≤–Ω—ã–π "–º–æ–∑–≥" FoodTracker. –ü–æ–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≤—ã–∑—ã–≤–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç—ã.

## –ö–æ–Ω—Ç—Ä–∞–∫—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

### –í—Ö–æ–¥:
```json
{
  "message": "–Ø–∏—á–Ω–∏—Ü–∞ –Ω–∞ –∑–∞–≤—Ç—Ä–∞–∫",
  "systemPrefix": "CURRENT DATE: 2025-12-15\nTIMEZONE: Europe/Warsaw\n..."
}
```

### –í—ã—Ö–æ–¥:
```json
{
  "output": "–ó–∞–ø–∏—Å–∞–ª —è–∏—á–Ω–∏—Ü—É –Ω–∞ –∑–∞–≤—Ç—Ä–∞–∫! üç≥\n\n-- FoodTracker Bot"
}
```

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

| –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å | –¢–∏–ø | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å |
|-------------|-----|----------------|
| Memory Node | memory_input | üî¥ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û |
| Inject Context | –ü—Ä–µ–¥—à–µ—Å—Ç–≤—É–µ—Ç | üî¥ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û |
| OpenAI Credentials | LLM | üî¥ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û |
| 16 Tools | tool_input | üü° –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å |

## Tools (16 —à—Ç—É–∫)

| # | Tool | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|---|------|------------|
| 1-8 | Telegram Reports | –û—Ç—á–µ—Ç—ã /day, /week, /month |
| 9 | Add Meal | –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–µ–º –ø–∏—â–∏ |
| 10 | Get User Meals | –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø—Ä–∏–µ–º—ã |
| 11 | Search User Meals | –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ |
| 12 | Update User Meal | –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–µ–º |
| 13 | Get Meal by ID | –ü–æ–ª—É—á–∏—Ç—å –ø–æ ID |
| 14 | Delete User Meal | –£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–µ–º |
| 15-16 | Misc | –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ |

## DO NOT TOUCH! (–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)

| –ù–∞—Å—Ç—Ä–æ–π–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ | –ü–æ—á–µ–º—É –Ω–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å |
|-----------|----------|---------------------|
| Memory connection | –ü–æ–¥–∫–ª—é—á–µ–Ω | AI –Ω–µ –±—É–¥–µ—Ç –ø–æ–º–Ω–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç |
| Tools[*].jsonBody | –ù–ï–¢ (–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç) | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ–º–∞–µ—Ç HTTP (v432) |
| System Prompt | –†—É—Å—Å–∫–∏–π —è–∑—ã–∫ | –Æ–∑–µ—Ä —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–π |

## –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è —É–¥–∞–ª–µ–Ω–∏—è/–ø–æ–ª–æ–º–∫–∏
üî¥ **–ö–ê–¢–ê–°–¢–†–û–§–ê:** –ë–æ—Ç –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç –ø–æ–Ω–∏–º–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã, –≤—Å–µ AI —Ñ—É–Ω–∫—Ü–∏–∏ —Å–ª–æ–º–∞—é—Ç—Å—è.

## –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –í–µ—Ä—Å–∏—è | –ò–∑–º–µ–Ω–µ–Ω–∏–µ | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|--------|-----------|-----------|
| v432 | –î–æ–±–∞–≤–ª–µ–Ω jsonBody –≤ Tools | ‚ùå –ë–æ—Ç –∑–∞–º–æ–ª—á–∞–ª |
| v434 | –£–¥–∞–ª–µ–Ω jsonBody | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
| v442 | –ò–∑–º–µ–Ω–µ–Ω customKey –≤ Memory | ‚ùå –°–µ—Å—Å–∏–∏ —Å–ª–æ–º–∞–ª–∏—Å—å |
| v444 | –í–æ–∑–≤—Ä–∞—â–µ–Ω customKey | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |

## –ü—Ä–∞–≤–∏–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### ‚úÖ –ú–û–ñ–ù–û:
- –î–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ Tools
- –ò–∑–º–µ–Ω—è—Ç—å System Prompt (—Ç–µ–∫—Å—Ç)
- –ú–µ–Ω—è—Ç—å temperature/model

### ‚ùå –ù–ï–õ–¨–ó–Ø (–±–µ–∑ approval):
- –£–¥–∞–ª—è—Ç—å Memory connection
- –î–æ–±–∞–≤–ª—è—Ç—å jsonBody –∫ –ª—é–±–æ–º—É Tool
- –£–¥–∞–ª—è—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ Tools –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```

#### –§–∞–π–ª 10: `.context/technical/state.json`

```json
{
  "_description": "–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ workflow. Lazy load - —á–∏—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–µ—Ç–∞–ª–∏.",

  "workflow": {
    "id": "sw3Qs3Fe3JahEbbW",
    "name": "FoodTracker",
    "version": 514,
    "active": true,
    "updated": "2025-12-15"
  },

  "nodes": {
    "total": 58,
    "by_type": {
      "trigger": 2,
      "ai_agent": 1,
      "code": 10,
      "switch": 1,
      "http_request": 16,
      "telegram": 9,
      "other": 19
    }
  },

  "last_execution": {
    "status": "success",
    "timestamp": "2025-12-15T10:30:00Z"
  },

  "health": {
    "success_rate_7d": "85%",
    "avg_duration_ms": 2400
  },

  "_note": "–ü–æ–ª–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –Ω–æ–¥ ‚Üí MCP: n8n_get_workflow mode=structure"
}
```

---

### –§–ê–ó–ê 2: Shared —Ñ–∞–π–ª—ã –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤ (1 —á–∞—Å)

#### –§–∞–π–ª 11: `.claude/agents/shared/anti-hallucination.md`

```markdown
# L-075: Anti-Hallucination Protocol

> **–ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è:** –í–°–ï –∞–≥–µ–Ω—Ç—ã —Å MCP –¥–æ—Å—Ç—É–ø–æ–º
> **–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üî¥ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û

## STEP 0: MCP Check (–ü–ï–†–í–´–ô –®–ê–ì!)

```
–ü–µ—Ä–µ–¥ –ª—é–±–æ–π —Ä–∞–±–æ—Ç–æ–π –≤—ã–∑–æ–≤–∏:
mcp__n8n-mcp__n8n_list_workflows limit=1

‚úÖ –í–∏–¥–∏—à—å –¥–∞–Ω–Ω—ã–µ ‚Üí MCP —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–¥–æ–ª–∂–∞–π
‚ùå –û—à–∏–±–∫–∞ ‚Üí –°–¢–û–ü, —Å–æ–æ–±—â–∏ "MCP unavailable"
```

## –ó–∞–ø—Ä–µ—â–µ–Ω–æ (–ù–ò–ö–û–ì–î–ê!)

| –î–µ–π—Å—Ç–≤–∏–µ | –ü–æ—á–µ–º—É –∑–∞–ø—Ä–µ—â–µ–Ω–æ |
|----------|------------------|
| –í—ã–¥—É–º—ã–≤–∞—Ç—å workflow ID | –§–µ–π–∫ - ID –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç |
| "Workflow —Å–æ–∑–¥–∞–Ω" –±–µ–∑ MCP –æ—Ç–≤–µ—Ç–∞ | –õ–æ–∂—å - –Ω–∏—á–µ–≥–æ –Ω–µ —Å–æ–∑–¥–∞–Ω–æ |
| –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ | –ì–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏—è |
| –ü–∏—Å–∞—Ç—å success –±–µ–∑ `<function_results>` | –û–±–º–∞–Ω |

## –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ (–í–°–ï–ì–î–ê!)

1. **–õ–æ–≥–∏—Ä—É–π mcp_calls:**
   ```json
   {
     "mcp_calls": [
       {"tool": "n8n_create_workflow", "result_id": "abc123"},
       {"tool": "n8n_get_workflow", "verified": true}
     ]
   }
   ```

2. **–¶–∏—Ç–∏—Ä—É–π —Ç–æ—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã:**
   ```
   ‚úÖ "MCP –≤–µ—Ä–Ω—É–ª: {id: 'abc123', name: 'Test', nodes: [...]}"
   ‚ùå "Workflow —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω"
   ```

3. **–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–π:**
   ```
   –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è ‚Üí –≤—ã–∑–æ–≤–∏ n8n_get_workflow
   Workflow —Å—É—â–µ—Å—Ç–≤—É–µ—Ç? ‚Üí –¢–æ–ª—å–∫–æ —Ç–æ–≥–¥–∞ success
   ```

## –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ success

- [ ] –í–∏–¥–µ–ª `<function_results>` —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏?
- [ ] –ú–æ–≥—É –ø—Ä–æ—Ü–∏—Ç–∏—Ä–æ–≤–∞—Ç—å –¢–û–ß–ù–´–ô –æ—Ç–≤–µ—Ç API?
- [ ] workflow_id –∏–∑ –æ—Ç–≤–µ—Ç–∞ API (–Ω–µ –∏–∑ –≤–æ–æ–±—Ä–∞–∂–µ–Ω–∏—è)?
- [ ] –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–ª —á–µ—Ä–µ–∑ n8n_get_workflow?

**–ï—Å–ª–∏ –õ–Æ–ë–û–ô –ø—É–Ω–∫—Ç = –ù–ï–¢ ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–π error, –Ω–µ success!**
```

#### –§–∞–π–ª 12: `.claude/agents/shared/project-context.md`

```markdown
# –ü—Ä–æ—Ç–æ–∫–æ–ª –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞

> **–ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è:** –í–°–ï –∞–≥–µ–Ω—Ç—ã
> **–ö–æ–≥–¥–∞:** –í –Ω–∞—á–∞–ª–µ –ö–ê–ñ–î–û–ô –∑–∞–¥–∞—á–∏

## STEP 0: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç

```bash
# –ü—Ä–æ—á–∏—Ç–∞—Ç—å –∏–∑ run_state
project_path=$(jq -r '.project_path // empty' memory/run_state_active.json)

# –ï—Å–ª–∏ –Ω–µ—Ç –≤ run_state ‚Üí default
if [ -z "$project_path" ]; then
  project_path="/Users/sergey/Projects/ClaudeN8N"
fi
```

## STEP 1: –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç

**–ü–æ—Ä—è–¥–æ–∫ —á—Ç–µ–Ω–∏—è (–æ—Ç –æ–±—â–µ–≥–æ –∫ —á–∞—Å—Ç–Ω–æ–º—É):**

```
1. STRATEGY (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –≤—Å–µ—Ö):
   Read: {project_path}/.context/1-STRATEGY.md

2. INDEX (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –≤—Å–µ—Ö):
   Read: {project_path}/.context/2-INDEX.md

3. –î–ª—è Builder/QA - –µ—Å–ª–∏ –º–µ–Ω—è–µ—à—å –Ω–æ–¥—É:
   ‚Üí –ù–∞–π–¥–∏ –Ω–æ–¥—É –≤ INDEX
   ‚Üí –ü—Ä–æ—á–∏—Ç–∞–π —É–∫–∞–∑–∞–Ω–Ω—ã–π ADR –∏–ª–∏ Intent Card

4. –î–ª—è Researcher - –µ—Å–ª–∏ –∏—â–µ—à—å –ø–æ —Å–µ—Ä–≤–∏—Å—É:
   Read: {project_path}/.context/architecture/services/{service}.md
```

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –ø–æ –∞–≥–µ–Ω—Ç–∞–º

| –ê–≥–µ–Ω—Ç | –ß–∏—Ç–∞–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | –ß–∏—Ç–∞–µ—Ç –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ |
|-------|-------------------|------------------------|
| Architect | STRATEGY, INDEX | flow.md |
| Researcher | STRATEGY, INDEX | services/*.md, decisions/*.md |
| Builder | STRATEGY, INDEX | ADR/Intent Card –¥–ª—è –∏–∑–º–µ–Ω—è–µ–º–æ–π –Ω–æ–¥—ã |
| QA | STRATEGY, INDEX | flow.md |
| Analyst | –í–°–Å | - |

## Fallback (–µ—Å–ª–∏ .context/ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)

```bash
if [ ! -d "${project_path}/.context" ]; then
  echo "‚ö†Ô∏è Project context not found"
  echo "Fallback: Read ARCHITECTURE.md if exists"
  [ -f "${project_path}/ARCHITECTURE.md" ] && Read "${project_path}/ARCHITECTURE.md"
fi
```
```

#### –§–∞–π–ª 13: `.claude/agents/shared/surgical-edits.md`

```markdown
# Surgical Edits Protocol

> **–ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è:** Builder agent
> **–¶–µ–ª—å:** –ò–∑–º–µ–Ω—è—Ç—å –¢–û–õ–¨–ö–û –Ω—É–∂–Ω—ã–µ –Ω–æ–¥—ã, –Ω–µ —Ç—Ä–æ–≥–∞—Ç—å –æ—Å—Ç–∞–ª—å–Ω–æ–µ

## –ü—Ä–∞–≤–∏–ª–æ #1: Partial Updates ONLY

```
‚úÖ –ò–°–ü–û–õ–¨–ó–£–ô: n8n_update_partial_workflow
‚ùå –ó–ê–ü–†–ï–©–ï–ù–û: n8n_update_full_workflow (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ hook!)
```

## Workflow –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –û–ø—Ä–µ–¥–µ–ª–∏ scope

```javascript
// –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å?
const edit_scope = ["Switch"];  // –¢–æ–ª—å–∫–æ —ç—Ç–∏ –Ω–æ–¥—ã
```

### 2. –ß–∏—Ç–∞–π —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ–µ

```javascript
// –ù–ï —á–∏—Ç–∞–π –≤–µ—Å—å workflow!
// –ß–∏—Ç–∞–π structure + –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –Ω–æ–¥—ã

// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ (–ª–µ–≥–∫–æ–≤–µ—Å–Ω–∞—è)
const structure = await n8n_get_workflow({
  id: workflow_id,
  mode: "structure"  // ~2000 tokens
});

// –¢–æ–ª—å–∫–æ —Ü–µ–ª–µ–≤—ã–µ –Ω–æ–¥—ã
const details = await n8n_get_workflow({
  id: workflow_id,
  mode: "filtered",
  nodeNames: ["Switch"]  // –¢–æ–ª—å–∫–æ Switch
});
```

### 3. –ì–µ–Ω–µ—Ä–∏—Ä—É–π –æ–ø–µ—Ä–∞—Ü–∏–∏

```javascript
const operations = [
  {
    type: "updateNode",
    nodeName: "Switch",
    properties: {
      parameters: {
        rules: [...existing_rules, new_rule]
      }
    }
  }
];
```

### 4. –ü—Ä–∏–º–µ–Ω—è–π partial update

```javascript
const result = await n8n_update_partial_workflow({
  id: workflow_id,
  operations: operations
});
```

### 5. –õ–æ–≥–∏—Ä—É–π edit_scope

```javascript
return {
  status: "success",
  edit_scope: ["Switch"],  // –ß–¢–û –∏–∑–º–µ–Ω–∏–ª
  changes: ["Added /water case"],  // –ö–ê–ö –∏–∑–º–µ–Ω–∏–ª
  mcp_calls: [...]
};
```

## –¢–∏–ø—ã –æ–ø–µ—Ä–∞—Ü–∏–π

| –û–ø–µ—Ä–∞—Ü–∏—è | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å |
|----------|-------------------|
| `addNode` | –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –Ω–æ–¥—É |
| `updateNode` | –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π |
| `removeNode` | –£–¥–∞–ª–∏—Ç—å –Ω–æ–¥—É |
| `addConnection` | –°–æ–µ–¥–∏–Ω–∏—Ç—å –Ω–æ–¥—ã |
| `removeConnection` | –†–∞–∑—ä–µ–¥–∏–Ω–∏—Ç—å –Ω–æ–¥—ã |

## –ö–æ–≥–¥–∞ –¥–æ–ø—É—Å—Ç–∏–º full update (–∏—Å–∫–ª—é—á–µ–Ω–∏—è)

1. –°–æ–∑–¥–∞–Ω–∏–µ workflow —Å –Ω—É–ª—è
2. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ >50% –Ω–æ–¥ (—Å approval —é–∑–µ—Ä–∞)
3. partial_workflow –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É (fallback)

**–í —ç—Ç–∏—Ö —Å–ª—É—á–∞—è—Ö:** –ó–∞–ø—Ä–æ—Å–∏ approval —É —é–∑–µ—Ä–∞!

## –ß–µ–∫–ª–∏—Å—Ç

- [ ] –û–ø—Ä–µ–¥–µ–ª–∏–ª edit_scope?
- [ ] –ü—Ä–æ—á–∏—Ç–∞–ª —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –Ω–æ–¥—ã?
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª partial update?
- [ ] –ó–∞–ª–æ–≥–∏—Ä–æ–≤–∞–ª edit_scope –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç?
- [ ] –ü—Ä–æ–≤–µ—Ä–∏–ª —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –∑–∞—è–≤–ª–µ–Ω–Ω—ã–µ –Ω–æ–¥—ã?
```

#### –§–∞–π–ª 14: `.claude/agents/shared/context-update.md`

```markdown
# –ü—Ä–æ—Ç–æ–∫–æ–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

> **–ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è:** Analyst agent
> **–ö–æ–≥–¥–∞:** –ü–æ—Å–ª–µ –ö–ê–ñ–î–û–ì–û —É—Å–ø–µ—à–Ω–æ–≥–æ build (enforce —á–µ—Ä–µ–∑ hook)

## –ö–æ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è—Ç—å

| –°–æ–±—ã—Ç–∏–µ | –ß—Ç–æ –æ–±–Ω–æ–≤–∏—Ç—å |
|---------|--------------|
| –£—Å–ø–µ—à–Ω—ã–π build | 2-INDEX.md (–ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è) |
| –ò–∑–º–µ–Ω–µ–Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞—è –Ω–æ–¥–∞ | ADR –∏–ª–∏ Intent Card —ç—Ç–æ–π –Ω–æ–¥—ã |
| –ù–æ–≤—ã–π –∏–Ω—Ü–∏–¥–µ–Ω—Ç | –ò—Å—Ç–æ—Ä–∏—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º ADR |
| –ù–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å –¥–æ–±–∞–≤–ª–µ–Ω | –°–æ–∑–¥–∞—Ç—å Service Playbook |
| –ù–æ–≤–∞—è –∫—Ä–∏—Ç–∏—á–Ω–∞—è –Ω–æ–¥–∞ | –°–æ–∑–¥–∞—Ç—å Node Intent Card |

## –ß—Ç–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –≤ INDEX

### –°–µ–∫—Ü–∏—è "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"

```markdown
| –í–µ—Ä—Å–∏—è | –ò–∑–º–µ–Ω–µ–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|--------|-----------|--------|
| v515 | –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ /water | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |  ‚Üê –î–û–ë–ê–í–ò–¢–¨
| v514 | –î–æ–±–∞–≤–ª–µ–Ω operation=sendMessage | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç |
...
```

### –°–µ–∫—Ü–∏—è "Current State"

```markdown
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-12-15  ‚Üê –û–ë–ù–û–í–ò–¢–¨
**–í–µ—Ä—Å–∏—è workflow:** v515  ‚Üê –û–ë–ù–û–í–ò–¢–¨
```

## –ß—Ç–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –≤ ADR

### –ï—Å–ª–∏ –±—ã–ª –∏–Ω—Ü–∏–¥–µ–Ω—Ç:

–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–µ–∫—Ü–∏—é "–ò—Å—Ç–æ—Ä–∏—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤":

```markdown
### v515 (2025-12-15) - –ö–†–ê–¢–ö–û–ï –û–ü–ò–°–ê–ù–ò–ï
- **–ß—Ç–æ —Å–¥–µ–ª–∞–ª–∏:** ...
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚ùå/‚úÖ
- **–û—Ç–∫–∞—Ç:** (–µ—Å–ª–∏ –±—ã–ª)
- **–£—Ä–æ–∫:** ...
```

### –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ø—Ä–∞–≤–∏–ª–∞:

–û–±–Ω–æ–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é "DO NOT TOUCH" –∏–ª–∏ "–ü—Ä–∞–≤–∏–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π"

## –ß—Ç–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –≤ state.json

```json
{
  "workflow": {
    "version": 515,  // ‚Üê –û–ë–ù–û–í–ò–¢–¨
    "updated": "2025-12-15"  // ‚Üê –û–ë–ù–û–í–ò–¢–¨
  }
}
```

## –ß–µ–∫–ª–∏—Å—Ç –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

- [ ] INDEX.md - –≤–µ—Ä—Å–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞?
- [ ] INDEX.md - –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω—ã?
- [ ] ADR - –∏—Å—Ç–æ—Ä–∏—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤ (–µ—Å–ª–∏ –±—ã–ª)?
- [ ] state.json - –≤–µ—Ä—Å–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞?
- [ ] Git commit —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º?
```

---

### –§–ê–ó–ê 3: Hooks –¥–ª—è enforcement (30 –º–∏–Ω)

#### –§–∞–π–ª 15: `.claude/hooks/block-full-update.md`

```markdown
---
trigger: PreToolUse
tools:
  - mcp__n8n-mcp__n8n_update_full_workflow
---

# üö® BLOCKED: Full Workflow Update

## –ü–æ—á–µ–º—É –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ

`n8n_update_full_workflow` –∑–∞–º–µ–Ω—è–µ—Ç –í–°–ï –Ω–æ–¥—ã.

**–†–∏—Å–∫–∏:**
- –°–ª—É—á–∞–π–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –Ω–æ–¥–∞—Ö –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —Ç—Ä–æ–≥–∞–ª
- –ü–æ—Ç–µ—Ä—è –Ω–µ–¥–∞–≤–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –ü–æ–ª–æ–º–∫–∞ —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

## –ß—Ç–æ –¥–µ–ª–∞—Ç—å –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ

### –ò—Å–ø–æ–ª—å–∑—É–π partial update:

```javascript
mcp__n8n-mcp__n8n_update_partial_workflow({
  id: "workflow_id",
  operations: [
    {
      type: "updateNode",
      nodeName: "Switch",
      properties: { ... }
    }
  ]
})
```

### –ß–∏—Ç–∞–π –ø—Ä–æ—Ç–æ–∫–æ–ª:
`.claude/agents/shared/surgical-edits.md`

## –ò—Å–∫–ª—é—á–µ–Ω–∏—è (—Ç—Ä–µ–±—É—é—Ç approval)

–ï—Å–ª–∏ partial update –ù–ï–í–û–ó–ú–û–ñ–ï–ù:
1. –û–±—ä—è—Å–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ü–û–ß–ï–ú–£
2. –ü–æ–ª—É—á–∏ —è–≤–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
3. –°–æ–∑–¥–∞–π snapshot –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º

## –†–µ—à–µ–Ω–∏–µ

**BLOCK** - –∏—Å–ø–æ–ª—å–∑—É–π `n8n_update_partial_workflow`
```

#### –§–∞–π–ª 16: `.claude/hooks/enforce-context-update.md`

```markdown
---
trigger: PostToolUse
tools:
  - mcp__n8n-mcp__n8n_update_partial_workflow
  - mcp__n8n-mcp__n8n_create_workflow
---

# Context Update Reminder

## –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è workflow

–ï—Å–ª–∏ —Ç—ã **Builder** –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ:

1. –°–æ–æ–±—â–∏ Orchestrator —á—Ç–æ –Ω—É–∂–µ–Ω Analyst
2. Analyst –û–ë–Ø–ó–ê–ù –æ–±–Ω–æ–≤–∏—Ç—å:
   - `.context/2-INDEX.md` (–≤–µ—Ä—Å–∏—è, –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
   - `.context/technical/state.json` (–≤–µ—Ä—Å–∏—è)
   - ADR/Intent Card (–µ—Å–ª–∏ –∑–∞—Ç—Ä–æ–Ω—É—Ç–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞—è –Ω–æ–¥–∞)

## –ü—Ä–æ—Ç–æ–∫–æ–ª

–ß–∏—Ç–∞–π: `.claude/agents/shared/context-update.md`

## –†–µ—à–µ–Ω–∏–µ

**PROCEED** - –Ω–æ –Ω–∞–ø–æ–º–Ω–∏ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
```

---

### –§–ê–ó–ê 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ agent —Ñ–∞–π–ª–æ–≤ (1 —á–∞—Å)

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ builder.md

**–î–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—á–∞–ª–æ:**

```markdown
## STEP 0: Pre-flight (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)

### 1. MCP Check
–ß–∏—Ç–∞–π: `.claude/agents/shared/anti-hallucination.md`

### 2. Project Context
–ß–∏—Ç–∞–π: `.claude/agents/shared/project-context.md`

### 3. Surgical Edits Protocol
–ß–∏—Ç–∞–π: `.claude/agents/shared/surgical-edits.md`

**–ü–ï–†–ï–î –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –Ω–æ–¥—ã:**
1. –û—Ç–∫—Ä–æ–π `.context/2-INDEX.md`
2. –ù–∞–π–¥–∏ –Ω–æ–¥—É –≤ —Ç–∞–±–ª–∏—Ü–µ
3. –ü—Ä–æ—á–∏—Ç–∞–π —É–∫–∞–∑–∞–Ω–Ω—ã–π ADR/Intent Card
4. –ü—Ä–æ–≤–µ—Ä—å "DO NOT TOUCH" —Å–µ–∫—Ü–∏—é!
```

**–î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é Surgical Edits (—Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ, —Å–æ —Å—Å—ã–ª–∫–æ–π –Ω–∞ shared):**

```markdown
## Surgical Edits (–ö–†–ò–¢–ò–ß–ù–û!)

**–ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª:** `.claude/agents/shared/surgical-edits.md`

### Quick Reference:

```javascript
// 1. –û–ø—Ä–µ–¥–µ–ª–∏ scope
const edit_scope = ["Switch"];

// 2. –ß–∏—Ç–∞–π —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ–µ
n8n_get_workflow({ mode: "filtered", nodeNames: ["Switch"] })

// 3. Partial update
n8n_update_partial_workflow({ operations: [...] })

// 4. –õ–æ–≥–∏—Ä—É–π
return { edit_scope: ["Switch"], changes: [...] }
```

### –ó–ê–ü–†–ï–©–ï–ù–û:
- ‚ùå `n8n_update_full_workflow` (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ hook!)
- ‚ùå –ò–∑–º–µ–Ω—è—Ç—å –Ω–æ–¥—ã –≤–Ω–µ edit_scope
- ‚ùå –¢—Ä–æ–≥–∞—Ç—å "DO NOT TOUCH" –±–µ–∑ approval
```

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ qa.md

**–î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é Edit Scope Validation:**

```markdown
## Edit Scope Validation (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)

–ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ Builder –≤–µ—Ä–Ω—É–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

### 1. –ü—Ä–æ–≤–µ—Ä—å edit_scope —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

```javascript
if (!build_result.edit_scope || build_result.edit_scope.length === 0) {
  return {
    status: "FAIL",
    error: "Builder –Ω–µ —É–∫–∞–∑–∞–ª edit_scope",
    action: "Builder –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å —Å —É–∫–∞–∑–∞–Ω–∏–µ–º edit_scope"
  };
}
```

### 2. –°—Ä–∞–≤–Ω–∏ before/after

```javascript
// –ü–æ–ª—É—á–∏ –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é (–∏–∑ snapshot –∏–ª–∏ run_state)
const before = previous_workflow;
const after = current_workflow;

// –ù–∞–π–¥–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
const actual_changes = diff(before.nodes, after.nodes);
```

### 3. –ü—Ä–æ–≤–µ—Ä—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ

```javascript
for (const change of actual_changes) {
  if (!build_result.edit_scope.includes(change.node)) {
    return {
      status: "FAIL",
      error: `–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ: ${change.node}`,
      expected: build_result.edit_scope,
      actual: actual_changes.map(c => c.node)
    };
  }
}
```

### 4. –ü—Ä–æ–≤–µ—Ä—å Protected Nodes

```javascript
const protected_nodes = ["Telegram Trigger", "AI Agent", "Memory"];
const touched_protected = actual_changes.filter(
  c => protected_nodes.includes(c.node)
);

if (touched_protected.length > 0) {
  return {
    status: "BLOCKED",
    error: "–ò–∑–º–µ–Ω–µ–Ω–∞ protected –Ω–æ–¥–∞ –±–µ–∑ approval!",
    node: touched_protected[0].node,
    action: "–¢—Ä–µ–±—É–µ—Ç—Å—è approval –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
  };
}
```
```

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ analyst.md

**–î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é Context Update:**

```markdown
## Context Update Protocol (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ build!)

**–ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª:** `.claude/agents/shared/context-update.md`

### –ü–æ—Å–ª–µ –ö–ê–ñ–î–û–ì–û —É—Å–ø–µ—à–Ω–æ–≥–æ build:

1. **–û–±–Ω–æ–≤–∏ INDEX:**
   ```
   Edit: {project_path}/.context/2-INDEX.md
   - –î–æ–±–∞–≤—å –∑–∞–ø–∏—Å—å –≤ "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"
   - –û–±–Ω–æ–≤–∏ –≤–µ—Ä—Å–∏—é workflow
   - –û–±–Ω–æ–≤–∏ –¥–∞—Ç—É
   ```

2. **–û–±–Ω–æ–≤–∏ state.json:**
   ```
   Edit: {project_path}/.context/technical/state.json
   - workflow.version = –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è
   - workflow.updated = —Å–µ–≥–æ–¥–Ω—è
   ```

3. **–ï—Å–ª–∏ –±—ã–ª –∏–Ω—Ü–∏–¥–µ–Ω—Ç:**
   ```
   Edit: —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π ADR
   - –î–æ–±–∞–≤—å –≤ "–ò—Å—Ç–æ—Ä–∏—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤"
   ```

4. **–ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞—è –Ω–æ–¥–∞:**
   ```
   Edit: —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π ADR –∏–ª–∏ Intent Card
   - –û–±–Ω–æ–≤–∏ "–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π"
   ```
```

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ researcher.md –∏ architect.md

**–î–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—á–∞–ª–æ:**

```markdown
## STEP 0: Pre-flight (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)

### 1. MCP Check (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å MCP)
–ß–∏—Ç–∞–π: `.claude/agents/shared/anti-hallucination.md`

### 2. Project Context
–ß–∏—Ç–∞–π: `.claude/agents/shared/project-context.md`
```

---

### –§–ê–ó–ê 5: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ orch.md (30 –º–∏–Ω)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

1. **–î–æ–±–∞–≤–∏—Ç—å file-based context –≤ Task calls:**

```javascript
// –ë–´–õ–û:
Task({
  prompt: `## CONTEXT
${JSON.stringify(run_state)}`
})

// –°–¢–ê–õ–û:
Task({
  prompt: `## CONTEXT FILES
Read these files yourself:
1. memory/run_state_active.json
2. {project_path}/.context/2-INDEX.md
3. (agent-specific files per shared/project-context.md)`
})
```

2. **–î–æ–±–∞–≤–∏—Ç—å enforcement –ø–æ—Å–ª–µ Builder:**

```javascript
// –ü–æ—Å–ª–µ Builder –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
if (build_result.status === "success") {
  // –ü—Ä–æ–≤–µ—Ä—å edit_scope
  if (!build_result.edit_scope) {
    console.warn("‚ö†Ô∏è Builder –Ω–µ —É–∫–∞–∑–∞–ª edit_scope!");
  }

  // –í—ã–∑–æ–≤–∏ Analyst –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
  Task({
    subagent_type: "general-purpose",
    prompt: `## ROLE: Analyst
Read: .claude/agents/analyst.md

## TASK
Update project context after successful build.
Changes: ${build_result.changes}
Version: ${new_version}`
  });
}
```

---

### –§–ê–ó–ê 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (30 –º–∏–Ω)

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ hooks —Ä–∞–±–æ—Ç–∞—é—Ç
/orch --test hooks

# 2. –ü—Ä–æ—Å—Ç–∞—è –∑–∞–¥–∞—á–∞
/orch "Add /test command to FoodTracker Switch"

# –û–∂–∏–¥–∞–µ–º—ã–π flow:
# - Builder —á–∏—Ç–∞–µ—Ç INDEX ‚Üí –Ω–∞—Ö–æ–¥–∏—Ç Switch ‚Üí ADR-003
# - Builder —á–∏—Ç–∞–µ—Ç ADR-003 ‚Üí –≤–∏–¥–∏—Ç –ø—Ä–∞–≤–∏–ª–∞
# - Builder –∏—Å–ø–æ–ª—å–∑—É–µ—Ç partial update
# - Builder –ª–æ–≥–∏—Ä—É–µ—Ç edit_scope: ["Switch"]
# - QA –ø—Ä–æ–≤–µ—Ä—è–µ—Ç edit_scope
# - Analyst –æ–±–Ω–æ–≤–ª—è–µ—Ç INDEX

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ full update –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
# (Builder –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è ‚Üí hook –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç)

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å protected nodes
# –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–º–µ–Ω–∏—Ç—å Memory –±–µ–∑ approval ‚Üí –¥–æ–ª–∂–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å—Å—è
```

---

## –ò–¢–û–ì–û

### –°–æ–∑–¥–∞—ë—Ç—Å—è —Ñ–∞–π–ª–æ–≤: 16

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ | –§–∞–π–ª—ã |
|-----------|------------|-------|
| .context/ | 10 | STRATEGY, INDEX, flow, 3 ADR, 2 services, 1 node, state.json |
| shared/ | 4 | anti-hallucination, project-context, surgical-edits, context-update |
| hooks/ | 2 | block-full-update, enforce-context-update |

### –ò–∑–º–µ–Ω—è–µ—Ç—Å—è —Ñ–∞–π–ª–æ–≤: 6

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|-----------|
| builder.md | +surgical edits, +pre-flight |
| qa.md | +edit_scope validation |
| analyst.md | +context update protocol |
| researcher.md | +pre-flight |
| architect.md | +pre-flight |
| orch.md | +file-based context, +analyst enforcement |

### –£–¥–∞–ª—è–µ—Ç—Å—è: ~150 cycle —Ñ–∞–π–ª–æ–≤

### –í—Ä–µ–º—è: ~5-6 —á–∞—Å–æ–≤

### –†–µ–∑—É–ª—å—Ç–∞—Ç:
- ‚úÖ –ê–≥–µ–Ω—Ç—ã –ø–æ–Ω–∏–º–∞—é—Ç –ó–ê–ß–ï–ú (STRATEGY, Service Playbooks)
- ‚úÖ –ê–≥–µ–Ω—Ç—ã –ø–æ–Ω–∏–º–∞—é—Ç –ü–û–ß–ï–ú–£ (ADRs, Node Intent Cards)
- ‚úÖ Builder –Ω–µ –ª–æ–º–∞–µ—Ç (Surgical Edits + Hooks)
- ‚úÖ QA –ø—Ä–æ–≤–µ—Ä—è–µ—Ç scope
- ‚úÖ Analyst –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç (enforcement)

---

## –î–õ–Ø –°–õ–ï–î–£–Æ–©–ï–ì–û –ë–û–¢–ê

1. **–ü—Ä–æ—á–∏—Ç–∞–π —ç—Ç–æ—Ç —Ñ–∞–π–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é**
2. **–í—ã–ø–æ–ª–Ω—è–π –§–ê–ó–´ –ø–æ –ø–æ—Ä—è–¥–∫—É (0 ‚Üí 1 ‚Üí 2 ‚Üí 3 ‚Üí 4 ‚Üí 5 ‚Üí 6)**
3. **–°–æ–∑–¥–∞–≤–∞–π —Ñ–∞–π–ª—ã —Å –¢–û–ß–ù–´–ú —Å–æ–¥–µ—Ä–∂–∏–º—ã–º –∏–∑ —ç—Ç–æ–≥–æ –ø–ª–∞–Ω–∞**
4. **–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã - —Ç–µ—Å—Ç–∏—Ä—É–π**
5. **–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ - —Å–ø—Ä–æ—Å–∏ —é–∑–µ—Ä–∞**

**–ü—Ä–æ–µ–∫—Ç:** FoodTracker
**–ü—É—Ç—å:** `/Users/sergey/Projects/MultiBOT/bots/food-tracker/`
**Workflow ID:** `sw3Qs3Fe3JahEbbW`
