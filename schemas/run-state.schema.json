{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "run_state",
  "description": "State object passed between agents in the 5-agent orchestration system",
  "type": "object",
  "required": ["id", "user_request", "stage"],
  "properties": {
    "id": {
      "type": ["string", "null"],
      "description": "UUID for this execution"
    },
    "user_request": {
      "type": "string",
      "description": "Original user request"
    },
    "goal": {
      "type": "string",
      "description": "Parsed goal from user request"
    },
    "operation": {
      "enum": ["new", "patch"],
      "default": "new",
      "description": "Create new workflow or patch existing"
    },
    "stage": {
      "enum": ["clarification", "research", "decision", "credentials", "implementation", "build", "validate", "test", "complete", "blocked"],
      "description": "Current stage in the 5-phase workflow"
    },
    "cycle_count": {
      "type": "integer",
      "minimum": 0,
      "default": 0,
      "description": "Number of QA cycles completed"
    },
    "constraints": {
      "type": "array",
      "items": { "type": "string" },
      "description": "User-defined constraints"
    },
    "assumptions": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Assumptions made by agents"
    },
    "services": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Services involved (supabase, slack, etc.)"
    },
    "credentials_required": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Credentials needed for workflow"
    },

    "requirements": {
      "type": "object",
      "description": "Architect Phase 1: Clarified requirements",
      "properties": {
        "services": { "type": "array", "items": { "type": "string" } },
        "credentials_available": { "type": "array", "items": { "type": "string" } },
        "credentials_needed": { "type": "array", "items": { "type": "string" } },
        "trigger": { "enum": ["webhook", "schedule", "manual"] },
        "input_format": { "type": "string" },
        "output_action": { "type": "string" },
        "error_handling": { "enum": ["retry", "notify", "ignore"] }
      }
    },

    "research_request": {
      "type": "object",
      "description": "Architect Phase 2: Request for Researcher",
      "properties": {
        "services": { "type": "array", "items": { "type": "string" } },
        "trigger_type": { "type": "string" },
        "search_existing": { "type": "boolean", "default": true },
        "keywords": { "type": "array", "items": { "type": "string" } }
      }
    },

    "decision": {
      "type": "object",
      "description": "Architect Phase 3: User decision on approach",
      "properties": {
        "chosen": { "type": "string", "description": "template_id or workflow_id" },
        "action": { "enum": ["modify", "build_new"] },
        "reason": { "type": "string" }
      }
    },

    "blueprint": {
      "type": "object",
      "description": "Architect Phase 4: Final build plan",
      "properties": {
        "base_workflow_id": { "type": ["string", "null"], "description": "Existing workflow to modify" },
        "action": { "enum": ["modify", "build_new"] },
        "services": { "type": "array" },
        "pattern": { "type": "string" },
        "nodes_needed": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "type": { "type": "string" },
              "role": { "type": "string" },
              "key_params": { "type": "object" }
            }
          }
        },
        "changes_required": { "type": "array", "items": { "type": "string" } },
        "template_refs": { "type": "array" },
        "risks": { "type": "array" },
        "build_steps": { "type": "array" },
        "credentials_required": { "type": "array" }
      }
    },

    "build_guidance": {
      "type": "object",
      "description": "Researcher Phase Implementation: Detailed build instructions after decision",
      "properties": {
        "learnings_applied": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Learning IDs applied (L-015, L-042, etc.)"
        },
        "patterns_applied": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Pattern IDs applied (P-003, P-007, etc.)"
        },
        "node_configs": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "type": { "type": "string", "description": "n8n-nodes-base.webhook etc." },
              "key_params": { "type": "object", "description": "Required parameters from get_node" },
              "gotchas": { "type": "array", "items": { "type": "string" }, "description": "Common mistakes to avoid" },
              "example_config": { "type": "object", "description": "Working config example" }
            }
          },
          "description": "Detailed node configurations from get_node research"
        },
        "expression_examples": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "context": { "type": "string" },
              "expression": { "type": "string" },
              "explanation": { "type": "string" }
            }
          },
          "description": "n8n expression examples for this workflow"
        },
        "warnings": {
          "type": "array",
          "items": { "type": "string" },
          "description": "API limits, RLS checks, rate limits, etc."
        },
        "code_snippets": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "node_role": { "type": "string" },
              "language": { "enum": ["javascript", "python"] },
              "code": { "type": "string" },
              "notes": { "type": "string" }
            }
          },
          "description": "Code node snippets if needed"
        }
      }
    },

    "research_findings": {
      "type": "object",
      "description": "Researcher's findings with scoring",
      "properties": {
        "local_patterns_found": { "type": "array", "items": { "type": "string" } },
        "templates_found": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "name": { "type": "string" },
              "fit_score": { "type": "integer", "minimum": 0, "maximum": 100 },
              "popularity": {
                "type": "object",
                "properties": {
                  "views": { "type": "integer" },
                  "downloads": { "type": "integer" }
                }
              },
              "complexity": { "enum": ["simple", "medium", "complex"] },
              "modification_needed": { "type": "string" },
              "missing_from_request": { "type": "array", "items": { "type": "string" } }
            }
          }
        },
        "existing_workflows": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "name": { "type": "string" },
              "fit_score": { "type": "integer" },
              "can_modify": { "type": "boolean" },
              "modification_needed": { "type": "string" }
            }
          }
        },
        "nodes_found": { "type": "array" },
        "recommendation": { "type": "string" },
        "build_vs_modify": { "enum": ["modify", "build_new"] },
        "ready_for_builder": { "type": "boolean" },
        "ripple_targets": { "type": "array", "items": { "type": "string" } },
        "excluded": {
          "type": "array",
          "description": "Already tried solutions to exclude"
        }
      }
    },

    "workflow": {
      "type": "object",
      "description": "Builder's workflow output (summary only, full in file)",
      "properties": {
        "id": { "type": ["string", "null"] },
        "name": { "type": ["string", "null"] },
        "node_count": { "type": "integer", "description": "Number of nodes (summary)" },
        "full_result_file": { "type": "string", "description": "Path to full workflow JSON" },
        "nodes": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "name": { "type": "string" },
              "type": { "type": "string" },
              "parameters": { "type": "object" },
              "_meta": {
                "type": "object",
                "description": "QA annotations",
                "properties": {
                  "status": { "enum": ["ok", "warning", "error"] },
                  "error": { "type": "string" },
                  "suggested_fix": { "type": "string" },
                  "evidence": { "type": "string" },
                  "fix_attempts": { "type": "array" },
                  "snapshot_before_fix": { "type": "object" },
                  "regression_caused_by": { "type": "object" }
                }
              }
            }
          }
        },
        "connections": { "type": "object" },
        "graph_hash": { "type": ["string", "null"] },
        "actions": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "action": { "type": "string" },
              "mcp_tool": { "type": "string" },
              "node_id": { "type": "string" },
              "result": { "type": "string" },
              "timestamp": { "type": "string" }
            }
          }
        },
        "validation_passed": { "type": "boolean" },
        "created_or_updated": { "enum": ["created", "updated"] }
      }
    },

    "qa_report": {
      "type": "object",
      "description": "QA validation results (summary only, full in file)",
      "properties": {
        "validation_status": {
          "enum": ["passed", "passed_with_warnings", "failed", null]
        },
        "error_count": { "type": "integer", "description": "Number of errors (summary)" },
        "warning_count": { "type": "integer", "description": "Number of warnings (summary)" },
        "full_report_file": { "type": "string", "description": "Path to full QA report JSON" },
        "issues": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "node_id": { "type": "string" },
              "node_name": { "type": "string" },
              "severity": { "enum": ["error", "warning"] },
              "message": { "type": "string" },
              "evidence": { "type": "string" },
              "suggested_fix": { "type": "string" }
            }
          }
        },
        "failure_source": {
          "enum": ["implementation", "analysis", "unknown", null]
        },
        "activation_result": { "type": ["string", "null"] },
        "test_result": {
          "type": ["object", "null"],
          "properties": {
            "execution_id": { "type": "string" },
            "status": { "type": "string" },
            "error_message": { "type": "string" }
          }
        },
        "edit_scope": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Node IDs that Builder can modify"
        },
        "ready_for_deploy": { "type": ["boolean", "null"] },
        "fp_stats": {
          "type": "object",
          "description": "False positive tracking for validator improvement",
          "properties": {
            "total_issues": { "type": "integer" },
            "confirmed_issues": { "type": "integer" },
            "false_positives": { "type": "integer" },
            "fp_rate": { "type": "number", "minimum": 0, "maximum": 100 },
            "fp_categories": {
              "type": "object",
              "description": "Count by FP category: jsCode_as_expression, set_raw_mode, continueOnFail_intentional",
              "additionalProperties": { "type": "integer" }
            }
          }
        }
      }
    },

    "memory": {
      "type": "object",
      "description": "Persistent history for Analyst",
      "properties": {
        "issues_history": {
          "type": "array",
          "description": "ALL issues from ALL QA cycles"
        },
        "fixes_applied": {
          "type": "array",
          "description": "ALL fixes ever applied"
        },
        "regressions": {
          "type": "array",
          "description": "Issues caused by fixes"
        }
      }
    },

    "edit_scope": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Current nodes Builder can modify"
    },
    "errors": {
      "type": "array",
      "description": "Append-only error log",
      "items": {
        "type": "object",
        "properties": {
          "node_id": { "type": "string" },
          "message": { "type": "string" },
          "severity": { "enum": ["critical", "medium", "low"] },
          "fixable": { "type": "boolean" },
          "timestamp": { "type": "string" }
        }
      }
    },
    "fixes_tried": {
      "type": "array",
      "description": "Append-only fixes log"
    },
    "worklog": {
      "type": "array",
      "description": "High-level cycle summaries",
      "items": {
        "type": "object",
        "properties": {
          "ts": { "type": "string" },
          "cycle": { "type": "integer" },
          "agent": { "type": "string" },
          "action": { "type": "string" },
          "outcome": { "type": "string" },
          "nodes_changed": { "type": "array" },
          "qa_status": { "type": "string" }
        }
      }
    },
    "agent_log": {
      "type": "array",
      "description": "Detailed agent action log",
      "items": {
        "type": "object",
        "properties": {
          "ts": { "type": "string" },
          "agent": { "type": "string" },
          "action": { "type": "string" },
          "details": { "type": "object" }
        }
      }
    },
    "last_attempt_notes": {
      "type": "string",
      "description": "What failed in last cycle"
    },

    "finalized": {
      "type": "object",
      "properties": {
        "status": { "type": "boolean" },
        "at": { "type": ["string", "null"], "format": "date-time" }
      }
    },

    "impact_analysis": {
      "type": "object",
      "description": "Architect produces for MODIFY scenarios (when workflow_id provided)",
      "properties": {
        "dependency_graph": {
          "type": "object",
          "description": "Node relationships: outputs_to, receives_from, expressions_used",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "outputs_to": { "type": "array", "items": { "type": "string" } },
              "receives_from": { "type": "array", "items": { "type": "string" } },
              "expressions_used": { "type": "array", "items": { "type": "string" } }
            }
          }
        },
        "modification_zone": {
          "type": "object",
          "properties": {
            "target_nodes": { "type": "array", "items": { "type": "string" }, "description": "Nodes to be changed" },
            "affected_nodes": { "type": "array", "items": { "type": "string" }, "description": "Downstream dependencies" },
            "safe_nodes": { "type": "array", "items": { "type": "string" }, "description": "Unaffected nodes" },
            "blast_radius": { "type": "integer", "description": "Number of affected nodes" }
          }
        },
        "modification_sequence": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "order": { "type": "integer" },
              "node": { "type": "string" },
              "action": { "enum": ["create", "configure", "update_reference", "verify_unchanged", "delete"] },
              "risk": { "enum": ["low", "medium", "high"] }
            }
          }
        },
        "parameter_contracts": {
          "type": "object",
          "description": "Expected input/output for each node",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "expects_input": { "type": "object" },
              "provides_output": { "type": "object" }
            }
          }
        }
      }
    },

    "modification_progress": {
      "type": "object",
      "description": "Builder updates during incremental modification",
      "properties": {
        "total_steps": { "type": "integer" },
        "completed_steps": { "type": "integer" },
        "current_step": {
          "type": ["object", "null"],
          "properties": {
            "order": { "type": "integer" },
            "node": { "type": "string" },
            "action": { "type": "string" },
            "status": { "enum": ["pending", "in_progress", "completed", "failed"] }
          }
        },
        "snapshots": {
          "type": "object",
          "description": "Node state before each change (step_1, step_2, etc.)",
          "additionalProperties": { "type": "object" }
        },
        "rollback_available": { "type": "boolean" }
      }
    },

    "checkpoint_request": {
      "type": ["object", "null"],
      "description": "Builder requests checkpoint validation from QA",
      "properties": {
        "step": { "type": "integer" },
        "scope": { "type": "array", "items": { "type": "string" }, "description": "Node names to validate" },
        "type": { "enum": ["pre-change", "post-node", "post-service", "final"] }
      }
    },

    "checkpoint_reports": {
      "type": "array",
      "description": "QA produces after each checkpoint",
      "items": {
        "type": "object",
        "properties": {
          "step": { "type": "integer" },
          "type": { "type": "string" },
          "status": { "enum": ["passed", "passed_with_warnings", "failed"] },
          "scope": { "type": "array", "items": { "type": "string" } },
          "issues": { "type": "array" }
        }
      }
    },

    "circuit_breaker_state": {
      "type": "object",
      "description": "Per-agent failure tracking to prevent cascading failures",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "state": { "enum": ["CLOSED", "OPEN", "HALF_OPEN"] },
          "failure_count": { "type": "integer" },
          "failure_threshold": { "type": "integer", "default": 3 },
          "recovery_timeout": { "type": "integer", "default": 300, "description": "Seconds" },
          "last_failure": { "type": ["string", "null"], "format": "date-time" }
        }
      }
    },

    "usage": {
      "type": "object",
      "description": "Token/cost/time tracking for hard caps",
      "properties": {
        "tokens_used": { "type": "integer", "default": 0 },
        "agent_calls": { "type": "integer", "default": 0 },
        "qa_cycles": { "type": "integer", "default": 0 },
        "time_elapsed_seconds": { "type": "integer", "default": 0 },
        "cost_usd": { "type": "number", "default": 0 }
      }
    },

    "ai_configs": {
      "type": "object",
      "description": "AI node configurations from Architect dialog",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "system_prompt": { "type": "string" },
          "system_prompt_type": { "enum": ["define_below", "define_in_workflow"] },
          "tools": { "type": "array", "items": { "type": "string" } },
          "memory": {
            "type": "object",
            "properties": {
              "enabled": { "type": "boolean" },
              "session_key": { "type": "string" },
              "window_size": { "type": "integer" }
            }
          },
          "output_parser": { "type": "string" },
          "temperature": { "type": "number" },
          "model": { "type": "string" }
        }
      }
    },

    "canary_phase": {
      "type": ["string", "null"],
      "enum": ["synthetic", "canary", "sample", "full", null],
      "description": "Current canary testing phase"
    },

    "node_flags": {
      "type": "object",
      "description": "Per-node enable/disable with fallback behavior",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "enabled": { "type": "boolean", "default": true },
          "fallback": { "enum": ["skip", "error", "mock", "log_only"] },
          "mock_response": { "type": "object" },
          "static_response": { "type": "string" }
        }
      }
    }
  }
}
